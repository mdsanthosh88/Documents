USE [MA2Data]
GO

/****** Object:  StoredProcedure [dbo].[proc_GetNatCatDLevelFourData]    Script Date: 5/24/2022 10:13:54 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[proc_GetNatCatDLevelFourData]
@TIVQuartilesFilter dbo.IDsList READONLY,
@NLEQuartilesFilter dbo.IDsList READONLY,
@PMLQuartileFilter dbo.IDsList READONLY,
@MPLQuartileFilter dbo.IDsList READONLY,
@PerilHazardRatingFilter dbo.IDsList READONLY,
@PerilType dbo.IDsList READONLY,
@LpAcctKey int,
@UseLocationNo BIT=1,
@StartRowIndex INT = 1,
@PageSize INT = 999999,
@SortExpression VARCHAR(100) = NULL,
@SortDirection VARCHAR(100) = 'ASC',
@TotalRows INT OUTPUT,
@AccountID INT=100,
@LocationIDsList dbo.IDsList READONLY,
@AccountProfileRatingTypeID  INT = 1
WITH RECOMPILE
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @Matches TABLE 
	(
		RowNumber INT PRIMARY KEY,
		ID INT,
		LocationNo NVARCHAR(10),
		LocationCode NVARCHAR(10),
		CustomerLocationID NVARCHAR(75),
		LocationName NVARCHAR(75),
        Division NVARCHAR(75),
		SubDivision NVARCHAR(75),
		StreetAddress1 VARCHAR(45),
		StreetAddress2 VARCHAR(45),
        City NVARCHAR (75) NOT NULL,
        State NVARCHAR (75),
        Country NVARCHAR (75) NOT NULL,		
		TotalProperty BIGINT,
		BusinessInterruption BIGINT, 
		TotalInsurableValue BIGINT,
		LastSurveyDate DATETIME,
		PDValue_AtLastSurvey BIGINT,
		BIValue_AtLastSurvey BIGINT,
		LocationValue_AtLastSurvey BIGINT,
		SumsInsuredUpdatedAfterLastSurvey BIT,
		ATCEarthquakeZone VARCHAR(50),
		EarthquakeHazardRating VARCHAR(50),
		EarthquakeComment NVARCHAR(max),
		BuildingType VARCHAR(100),
		SoilConditions VARCHAR(50),
		BuildingIrregularities VARCHAR(50),
		EarthquakeSprinklerBracing VARCHAR(50),
		EarthquakeSprinklerBracingComments NVARCHAR(max),
		EQ_NLE_PD DECIMAL(15,2),
		EQ_NLE_PDAmount DECIMAL(30,2),
		EQ_NLE_BI DECIMAL(15,2),
		EQ_NLE_BIAmount DECIMAL(15,2),
		EQ_NLE_IBI DECIMAL(30,2),
		EQ_NLE_BITotal DECIMAL(30,2),
		EQ_NLETotal DECIMAL(30,2),
		EQ_NLEofTIV DECIMAL(15,2),		
		EQ_NLEScenarioDescription NVARCHAR(4000),
		EQ_PMLPdPercentage  DECIMAL(15,2),
		EQ_PMLPdValue  DECIMAL(30,2),
		EQ_PMLBiPercentage DECIMAL(15,2),
		EQ_PMLBiValue  DECIMAL(15,2),
		EQ_PML_IBI DECIMAL(30,2),
		EQ_PML_BITotal DECIMAL(30,2),
		EQ_PMLTotal DECIMAL(30,2),
		EQ_PMLofTIV DECIMAL(30,2),
		EQ_PMLDescription  NVARCHAR(4000),
		EQ_MPLPdPercentage DECIMAL(15,2),
		EQ_MPLPdValue DECIMAL(30,2),
		EQ_MPLBiPercentage DECIMAL(15,2),
		EQ_MPLBiValue DECIMAL(15,2),
		EQ_MPL_IBI DECIMAL(30,2),
		EQ_MPL_BITotal DECIMAL(30,2),
		EQ_MPLTotal DECIMAL(30,2),
		EQ_MPLofTIV DECIMAL(15,2),
		EQ_MPLDescription NVARCHAR(4000),
		FEMAFloodZone VARCHAR(50),
		FloodHazardRating  VARCHAR(50),
		FloodHazardComment  NVARCHAR(max),
		LowestFinishedFloorElevation  VARCHAR(50),
		HundredYearFloodElevation  VARCHAR(50),
		HundredYearFloodElevationComments NVARCHAR(max),
		FloodProtectionPresent  VARCHAR(50),
		FloodProtectionPresentComments  NVARCHAR(max),
		FL_NLE_PD DECIMAL(15,2),
		FL_NLE_PDAmount DECIMAL(30,2),
		FL_NLE_BI DECIMAL(15,2),
		FL_NLE_BIAmount DECIMAL(15,2),
		FL_NLE_IBI DECIMAL(30,2),
		FL_NLE_BITotal DECIMAL(30,2),
		FL_NLETotal DECIMAL(30,2),
		FL_NLEofTIV  DECIMAL(15,2),		
		FL_NLEScenarioDescription NVARCHAR(4000),
		FL_PMLPdPercentage  DECIMAL(15,2),
		FL_PMLPdValue  DECIMAL(30,2),
		FL_PMLBiPercentage DECIMAL(15,2),
		FL_PMLBiValue  DECIMAL(15,2),
		FL_PML_IBI DECIMAL(30,2),
		FL_PML_BITotal DECIMAL(30,2),
		FL_PMLTotal DECIMAL(30,2),
		FL_PMLofTIV DECIMAL(30,2),
		FL_PMLDescription  NVARCHAR(4000),
		FL_MPLPdPercentage DECIMAL(15,2),
		FL_MPLPdValue DECIMAL(30,2),
		FL_MPLBiPercentage DECIMAL(15,2),
		FL_MPLBiValue DECIMAL(15,2),
		FL_MPL_IBI DECIMAL(30,2),
		FL_MPL_BITotal DECIMAL(30,2),
		FL_MPLTotal DECIMAL(30,2),
		FL_MPLofTIV DECIMAL(15,2),
		FL_MPLDescription NVARCHAR(4000),
		WindStormZone VARCHAR(50),
		WindstormHazardRating VARCHAR(50),
		WindstormHazardComment NVARCHAR(max),
		WindExposedSite VARCHAR(50),
		PredominantRoofConstruction VARCHAR(50),
		Vulnerabilityofcontentstowaterdamage VARCHAR(50),
		BuildingOpenings VARCHAR(50),
		SeaDistance VARCHAR(50),
		SeaDistanceComments NVARCHAR(max),
		WIN_NLE_PD DECIMAL(15,2),
		WIN_NLE_PDAmount DECIMAL(30,2),
		WIN_NLE_BI DECIMAL(15,2),
		WIN_NLE_BIAmount DECIMAL(15,2),
		WIN_NLE_IBI DECIMAL(30,2),
		WIN_NLE_BITotal DECIMAL(30,2),		
		WIN_NLETotal DECIMAL(30,2) NULL,
		WIN_NLEofTIV DECIMAL(30,2),-- DECIMAL(15,2),		
		WIN_NLEScenarioDescription NVARCHAR(4000),
		WIN_PMLPdPercentage  DECIMAL(15,2),
		WIN_PMLPdValue  DECIMAL(30,2),
		WIN_PMLBiPercentage DECIMAL(15,2),
		WIN_PMLBiValue  DECIMAL(15,2),
		WIN_PML_IBI DECIMAL(30,2),
		WIN_PML_BITotal DECIMAL(30,2),
		WIN_PMLTotal DECIMAL(30,2),
		WIN_PMLofTIV DECIMAL(30,2),
		WIN_PMLDescription  NVARCHAR(4000),
		WIN_MPLPdPercentage DECIMAL(15,2),
		WIN_MPLPdValue DECIMAL(30,2),
		WIN_MPLBiPercentage DECIMAL(15,2),
		WIN_MPLBiValue DECIMAL(15,2),
		WIN_MPL_IBI DECIMAL(30,2),
		WIN_MPL_BITotal DECIMAL(30,2),
		WIN_MPLTotal DECIMAL(30,2),
		WIN_MPLofTIV DECIMAL(15,2),
		WIN_MPLDescription NVARCHAR(4000),
		OtherNatCat VARCHAR(2),
        OtherNatCatComments VARCHAR(MAX),
		OtherNatcat_NLE_PD DECIMAL(15,2),
		OtherNatcat_NLE_PDAmount DECIMAL(30,2),
		OtherNatcat_NLE_BI DECIMAL(15,2),
		OtherNatcat_NLE_IBI DECIMAL(30,2),
		OtherNatcat_NLE_BITotal DECIMAL(30,2),
		OtherNatcat_NLE_BIAmount DECIMAL(15,2),
		OtherNatcat_NLETotal DECIMAL(30,2) NULL,
		OtherNatcat_NLEofTIV DECIMAL(30,2),-- DECIMAL(15,2),		
		OtherNatcat_NLEScenarioDescription NVARCHAR(4000),
		OtherNatcat_PMLPdPercentage  DECIMAL(15,2),
		OtherNatcat_PMLPdValue  DECIMAL(30,2),
		OtherNatcat_PMLBiPercentage DECIMAL(15,2),
		OtherNatcat_PMLBiValue  DECIMAL(15,2),
		OtherNatcat_PML_IBI DECIMAL(30,2),
		OtherNatcat_PML_BITotal DECIMAL(30,2),
		OtherNatcat_PMLTotal DECIMAL(30,2),
		OtherNatcat_PMLofTIV DECIMAL(30,2),
		OtherNatcat_PMLDescription  NVARCHAR(4000),
		OtherNatcat_MPLPdPercentage DECIMAL(15,2),
		OtherNatcat_MPLPdValue DECIMAL(30,2),
		OtherNatcat_MPLBiPercentage DECIMAL(15,2),
		OtherNatcat_MPLBiValue DECIMAL(15,2),
		OtherNatcat_MPL_IBI DECIMAL(30,2),
		OtherNatcat_MPL_BITotal DECIMAL(30,2),
		OtherNatcat_MPLTotal DECIMAL(30,2),
		OtherNatcat_MPLofTIV DECIMAL(15,2),
		OtherNatcat_MPLDescription NVARCHAR(4000),
		Images VARCHAR(100),
		LossEstimatesAlignedToCurrentValues BIT
       
        

	)
	-------- Pseudo constants
	

	DECLARE @PerilType_ALL AS INT = -1
	DECLARE @PerilType_Flood AS INT = 3
	DECLARE @PerilType_Earthquake AS INT = 4
	DECLARE @PerilType_Windstorm AS INT = 5	
	DECLARE @PerilType_Other AS INT = 6

	DECLARE @PerilTypeALL AS INT
	SELECT @PerilTypeALL=LossTypeid FROM NatCatType  
	DECLARE @peril AS INT
	SELECT @peril=ID FROM @PerilType


    DECLARE @TivFiter_All AS INT = 0
	DECLARE @TivFiter_Top0to25 AS INT = 1
	DECLARE @TivFiter_Top26to50 AS INT = 2
	DECLARE @TivFiter_Top51to75 AS INT = 3
	DECLARE @TivFiter_Top76to100 AS INT = 4

	DECLARE @NleFiter_All AS INT = 0
	DECLARE @NleFiter_Top0to25 AS INT = 1
	DECLARE @NleFiter_Top26to50 AS INT = 2
	DECLARE @NleFiter_Top51to75 AS INT = 3
	DECLARE @NleFiter_Top76to100 AS INT = 4
	DECLARE @NleFiter_Highest10 AS INT = 5

	DECLARE @PmlFiter_All AS INT = 0
	DECLARE @PmlFiter_Top0to25 AS INT = 1
	DECLARE @PmlFiter_Top26to50 AS INT = 2
	DECLARE @PmlFiter_Top51to75 AS INT = 3
	DECLARE @PmlFiter_Top76to100 AS INT=4
	DECLARE @PmlFiter_Highest10 AS INT = 5

	DECLARE @MplFiter_All AS INT = 0
	DECLARE @MplFiter_Top0to25 AS INT = 1
	DECLARE @MplFiter_Top26to50 AS INT = 2
	DECLARE @MplFiter_Top51to75 AS INT = 3
	DECLARE @MPLFiter_Top76to100 AS INT=4
	DECLARE @MplFiter_Highest10 AS INT = 5

	DECLARE @PerilHazardRating_All AS INT = 0
	DECLARE @PerilHazardRating_Negligible AS INT = 1
	DECLARE @PerilHazardRating_Low AS INT = 2
	DECLARE @PerilHazardRating_Moderate AS INT = 3
	DECLARE @PerilHazardRating_High AS INT=4
	DECLARE @PerilHazardRating_Not_Evaluated AS INT = 5
	
		

CREATE TABLE #NatCatFlood(
	[ID] INT,
	Flood_LEType INT,
	Flood_Zone NVARCHAR(255), 
	Flood_ExpectationLevel NVARCHAR(255),
	Flood_Comment NVARCHAR(MAX), 
	NLE_PDPercentage DECIMAL(15,2) NULL,
	NLE_PDValue DECIMAL(30,2) NULL, 
	NLE_BIPercentage DECIMAL(15,2) NULL,
	NLE_BIValue DECIMAL(15,2) NULL,
	NLE_IBI DECIMAL(30,2) NULL,
	NLE_BITotal DECIMAL(30,2) NULL,
	NLE_Total DECIMAL(30,2) NULL, 
	NLE_Description NVARCHAR(MAX) NULL,
	MPL_PDPercentage DECIMAL(15,2) NULL,
	MPL_PDValue DECIMAL(30,2) NULL, 
	MPL_BIPercentage DECIMAL(15,2) NULL, 
	MPL_BIValue DECIMAL(15,2) NULL,
	MPL_IBI DECIMAL(30,2) NULL,
	MPL_BITotal DECIMAL(30,2) NULL,
	MPL_Total DECIMAL(30,2) NULL, 
	MPL_Description NVARCHAR(MAX) NULL,
	PML_PDPercentage DECIMAL(15,2) NULL,
	PML_PDValue DECIMAL(30,2) NULL, 
	PML_BIPercentage DECIMAL(15,2) NULL, 
	PML_BIValue DECIMAL(15,2) NULL,
	PML_IBI DECIMAL(30,2) NULL,
	PML_BITotal DECIMAL(30,2) NULL,
	PML_Total DECIMAL(30,2) NULL, 
	PML_Description NVARCHAR(MAX) NULL,
	NLE_Percentage_of_TIV DECIMAL(15,2) NULL,
	PML_Percentage_of_TIV DECIMAL(15,2) NULL,
	MPL_Percentage_of_TIV DECIMAL(15,2) NULL)
INSERT INTO #NatCatFlood
	SELECT 	
	l.ID,	
	nct.LossTypeID as Flood_LEType,
	ncr.Zone as Flood_Zone,
	CASE ncr.ExpectationLevel 		
		WHEN 2 THEN 'Low'
		WHEN 3 THEN 'Moderate'		
		WHEN 4 THEN 'High'		
		ELSE 'Not Evaluated'
	END as Flood_ExpectationLevel,
	nce.Comment as Flood_Comment,
	lle.NLE_PDPercentage as NLE_PDPercentage,
	lle.NLE_PDValue as NLE_PDValue,
	lle.NLE_BIPercentage as NLE_BIPercentage,
	lle.NLE_BIValue as NLE_BIValue,
	lle.NLE_IBI as  NLE_IBI ,
	--lle.NLE_BITotal as NLE_BITotal,
	ISNULL(lle.NLE_BIValue, 0) + ISNULL(lle.NLE_IBI, 0) AS NLE_BITotal,
	--lle.NLE_Total  as [NLE_Total],	
	ISNULL(lle.NLE_PDValue, 0) + ISNULL(lle.NLE_BIValue, 0)+ ISNULL(lle.NLE_IBI, 0) AS [NLE_Total],
	(lle.NLE_LossScenarioSanitised + ' || ' + lle.NLE_DescriptionSanitised ) as  [NLE_Description],
	lle.MFL_PDPercentage as MPL_PDPercentage,
	lle.MFL_PDValue as MPL_PDValue,
	lle.MFL_BIPercentage as MPL_BIPercentage,
	lle.MFL_BIValue as MPL_BIValue,
	lle.MFL_IBI as  MPL_IBI ,
	--lle.MFL_BITotal as MPL_BITotal,
	ISNULL(lle.MFL_BIValue, 0) + ISNULL(lle.MFL_IBI, 0) AS MPL_BITotal,
	--lle.MFL_Total  as [MPL_Total],	
	ISNULL(lle.MFL_PDValue, 0) + ISNULL(lle.MFL_BIValue, 0)+ ISNULL(lle.MFL_IBI, 0) AS [MPL_Total],
	(lle.MFL_LossScenarioSanitised  + ' || ' +  lle.MFL_DescriptionSanitised )as  [MPL_Description],
	lle.PML_PDPercentage as PML_PDPercentage,
	lle.PML_PDValue as PML_PDValue,
	lle.PML_BIPercentage as PML_BIPercentage,
	lle.PML_BIValue as PML_BIValue,
	lle.PML_IBI as  PML_IBI ,
	--lle.PML_BITotal as PML_BITotal,
	ISNULL(lle.PML_BIValue, 0) + ISNULL(lle.PML_IBI, 0) AS PML_BITotal,
	--lle.PML_Total  as [PML_Total],		
	ISNULL(lle.PML_PDValue, 0) + ISNULL(lle.PML_BIValue, 0)+ ISNULL(lle.PML_IBI, 0) AS PML_Total,
	(lle.PML_LossScenarioSanitised  + ' || ' +  lle.PML_DescriptionSanitised )as  [PML_Description],
	lle.NLE_Percentage_of_TIV,
	lle.PML_Percentage_of_TIV,
	lle.MPL_Percentage_of_TIV
	FROM 	 LocationNatCatExposure nce

		LEFT JOIN NatCatExposureRating ncr ON ncr.ID=nce.NatCatExposureRatingID
		LEFT JOIN NatCatType nct ON nct.ID=ncr.NatCatTypeID
		LEFT JOIN [Location] l ON nce.LocationID= l.ID
		LEFT JOIN LocationLossEstimate lle ON lle.LocationID=l.ID and lle.LossTypeID=nct.LossTypeID

	WHERE 	l.LpAcctKey = @LpAcctKey 
		AND l.LpAllPiKey IN ( SELECT lid.ID FROM @LocationIDsList lid )
		AND nct.LossTypeID =@PerilType_Flood



CREATE TABLE #NatCatEQ(
		[ID] INT,
		EQ_LEType INT,
		EQ_Zone NVARCHAR(255), 
		EQ_ExpectationLevel NVARCHAR(255), 
		EQ_Comment NVARCHAR(MAX), 
		NLE_PDPercentage DECIMAL(15,2) NULL,
		NLE_PDValue DECIMAL(30,2) NULL, 
		NLE_BIPercentage DECIMAL(15,2) NULL,
		NLE_BIValue DECIMAL(15,2) NULL,
		NLE_IBI DECIMAL(30,2) NULL,
	    NLE_BITotal DECIMAL(30,2) NULL,
		NLE_Total DECIMAL(30,2) NULL, 
		NLE_Description NVARCHAR(MAX) NULL,
		MPL_PDPercentage DECIMAL(15,2) NULL,
		MPL_PDValue DECIMAL(30,2) NULL, 
		MPL_BIPercentage DECIMAL(15,2) NULL, 
		MPL_BIValue DECIMAL(15,2) NULL,
		MPL_IBI DECIMAL(30,2) NULL,
	    MPL_BITotal DECIMAL(30,2) NULL,
		MPL_Total DECIMAL(30,2) NULL, 
		MPL_Description NVARCHAR(MAX) NULL,
		PML_PDPercentage DECIMAL(15,2) NULL,
		PML_PDValue DECIMAL(30,2) NULL, 
		PML_BIPercentage DECIMAL(15,2) NULL, 
		PML_BIValue DECIMAL(15,2) NULL,
		PML_IBI DECIMAL(30,2) NULL,
	    PML_BITotal DECIMAL(30,2) NULL,
		PML_Total DECIMAL(30,2) NULL, 
		PML_Description NVARCHAR(MAX) NULL,
		NLE_Percentage_of_TIV DECIMAL(15,2) NULL,
		PML_Percentage_of_TIV DECIMAL(15,2) NULL,
		MPL_Percentage_of_TIV DECIMAL(15,2) NULL
		) 
INSERT INTO #NatCatEQ
	SELECT 	
	l.ID,	
	nct.LossTypeID as EQ_LEType,
	ncr.Zone as EQ_Zone ,
	CASE ncr.ExpectationLevel 
		WHEN 1 THEN 'Negligible'
		WHEN 2 THEN 'Low'		
		WHEN 3 THEN 'Moderate'
		WHEN 4 THEN 'High'
		ELSE 'Not Evaluated'
	END as EQ_ExpectationLevel,
	nce.Comment as EQ_Comment,
	lle.NLE_PDPercentage as NLE_PDPercentage,
	lle.NLE_PDValue as NLE_PDValue,
	lle.NLE_BIPercentage as NLE_BIPercentage,
	lle.NLE_BIValue as NLE_BIValue,
	lle.NLE_IBI as NLE_IBI,
 --    lle.NLE_BITotal as NLE_BITotal,
	--lle.NLE_Total  as [NLE_Total],		
	ISNULL(lle.NLE_BIValue, 0) + ISNULL(lle.NLE_IBI, 0) AS NLE_BITotal,	
	ISNULL(lle.NLE_PDValue, 0) + ISNULL(lle.NLE_BIValue, 0)+ ISNULL(lle.NLE_IBI, 0) AS [NLE_Total],
	(lle.NLE_LossScenarioSanitised + ' || ' + lle.NLE_DescriptionSanitised )as  [NLE_Description],
	lle.MFL_PDPercentage as MPL_PDPercentage,
	lle.MFL_PDValue as MPL_PDValue,
	lle.MFL_BIPercentage as MPL_BIPercentage,
	lle.MFL_BIValue as MPL_BIValue,
	lle.MFL_IBI as MPL_IBI,
 --    lle.MFL_BITotal as MPL_BITotal,
	--lle.MFL_Total  as [MPL_Total],		
	ISNULL(lle.MFL_BIValue, 0) + ISNULL(lle.MFL_IBI, 0) AS MPL_BITotal,		
	ISNULL(lle.MFL_PDValue, 0) + ISNULL(lle.MFL_BIValue, 0)+ ISNULL(lle.MFL_IBI, 0) AS [MPL_Total],
	(lle.MFL_LossScenarioSanitised +' || ' +  lle.MFL_DescriptionSanitised )as  [MPL_Description],
	lle.PML_PDPercentage as PML_PDPercentage,
	lle.PML_PDValue as PML_PDValue,
	lle.PML_BIPercentage as PML_BIPercentage,
	lle.PML_BIValue as PML_BIValue,
	lle.PML_IBI as PML_IBI,
 --    lle.PML_BITotal as PML_BITotal,
	--lle.PML_Total  as [PML_Total],		
	ISNULL(lle.PML_BIValue, 0) + ISNULL(lle.PML_IBI, 0) AS PML_BITotal,	
	ISNULL(lle.PML_PDValue, 0) + ISNULL(lle.PML_BIValue, 0)+ ISNULL(lle.PML_IBI, 0) AS PML_Total,
	(lle.PML_LossScenarioSanitised +' || ' + lle.PML_DescriptionSanitised )as  [PML_Description],
	lle.NLE_Percentage_of_TIV,
	lle.PML_Percentage_of_TIV,
	lle.MPL_Percentage_of_TIV
	FROM 	 LocationNatCatExposure nce
		LEFT JOIN NatCatExposureRating ncr ON ncr.ID=nce.NatCatExposureRatingID
		LEFT JOIN NatCatType nct ON nct.ID=ncr.NatCatTypeID
		LEFT JOIN [Location] l ON nce.LocationID= l.ID
		LEFT JOIN LocationLossEstimate lle ON lle.LocationID=l.ID and lle.LossTypeID=nct.LossTypeID
	WHERE 	l.LpAcctKey = @LpAcctKey 
		AND l.LpAllPiKey IN ( SELECT lid.ID FROM @LocationIDsList lid )
		AND nct.LossTypeID =@PerilType_Earthquake



CREATE TABLE #NatCatWind(
		[ID] INT,
		Wind_LEType INT, 
		Wind_Zone NVARCHAR(255), 
		Wind_ExpectationLevel NVARCHAR(255), 
		Wind_Comment NVARCHAR(MAX),
		NLE_PDPercentage DECIMAL(15,2) NULL,
		NLE_PDValue DECIMAL(30,2) NULL, 
		NLE_BIPercentage DECIMAL(15,2) NULL,
		NLE_BIValue DECIMAL(15,2) NULL,
		NLE_IBI DECIMAL(30,2) NULL,
	    NLE_BITotal DECIMAL(30,2) NULL,
		NLE_Total DECIMAL(30,2) NULL, 
		NLE_Description NVARCHAR(MAX) NULL,
		MPL_PDPercentage DECIMAL(15,2) NULL,
		MPL_PDValue DECIMAL(30,2) NULL, 
		MPL_BIPercentage DECIMAL(15,2) NULL, 
		MPL_BIValue DECIMAL(15,2) NULL,
		MPL_IBI DECIMAL(30,2) NULL,
	    MPL_BITotal DECIMAL(30,2) NULL,
		MPL_Total DECIMAL(30,2) NULL, 
		MPL_Description NVARCHAR(MAX) NULL,
		PML_PDPercentage DECIMAL(15,2) NULL,
		PML_PDValue DECIMAL(30,2) NULL, 
		PML_BIPercentage DECIMAL(15,2) NULL, 
		PML_BIValue DECIMAL(15,2) NULL,
		PML_IBI DECIMAL(30,2) NULL,
	    PML_BITotal DECIMAL(30,2) NULL,
		PML_Total DECIMAL(30,2) NULL, 
		PML_Description NVARCHAR(MAX) NULL,
		NLE_Percentage_of_TIV DECIMAL(15,2) NULL,
		PML_Percentage_of_TIV DECIMAL(15,2) NULL,
		MPL_Percentage_of_TIV DECIMAL(15,2) NULL
		)
INSERT INTO #NatCatWind
	SELECT 	
	l.ID,	
	nct.LossTypeID as Wind_LEType,
	ncr.Zone as Wind_Zone ,
	CASE ncr.ExpectationLevel 
		WHEN 1 THEN 'Negligible'
		WHEN 2 THEN 'Low'		
		WHEN 3 THEN 'Moderate'
		WHEN 4 THEN 'High'
		ELSE 'Not Evaluated'
	END as Wind_ExpectationLevel,
	nce.Comment as Wind_Comment,
	lle.NLE_PDPercentage as NLE_PDPercentage,
	lle.NLE_PDValue as NLE_PDValue,
	lle.NLE_BIPercentage as NLE_BIPercentage,
	lle.NLE_BIValue as NLE_BIValue,
	lle.[NLE_IBI]  as NLE_IBI,
	--lle.NLE_BITotal as LE_BITotal,
	--lle.NLE_Total  as [NLE_Total],
	ISNULL(lle.NLE_BIValue, 0) + ISNULL(lle.NLE_IBI, 0) AS NLE_BITotal,	
	ISNULL(lle.NLE_PDValue, 0) + ISNULL(lle.NLE_BIValue, 0)+ ISNULL(lle.NLE_IBI, 0) AS [NLE_Total],
	(lle.NLE_LossScenarioSanitised +' || ' +  lle.NLE_DescriptionSanitised )as  [NLE_Description],
	lle.MFL_PDPercentage as MPL_PDPercentage,
	lle.MFL_PDValue as MPL_PDValue,
	lle.MFL_BIPercentage as MPL_BIPercentage,
	lle.MFL_BIValue as MPL_BIValue,
	lle.MFL_IBI  as MFL_IBI,
	--lle.MFL_BITotal as MFL_BITotal,
	--lle.MFL_Total  as [MPL_Total],			
	ISNULL(lle.MFL_BIValue, 0) + ISNULL(lle.MFL_IBI, 0) AS MPL_BITotal,		
	ISNULL(lle.MFL_PDValue, 0) + ISNULL(lle.MFL_BIValue, 0)+ ISNULL(lle.MFL_IBI, 0) AS [MPL_Total],
	(lle.MFL_LossScenarioSanitised +' || ' +  lle.MFL_DescriptionSanitised )as  [MPL_Description],
	lle.PML_PDPercentage as PML_PDPercentage,
	lle.PML_PDValue as PML_PDValue,
	lle.PML_BIPercentage as PML_BIPercentage,
	lle.PML_BIValue as PML_BIValue,
	lle.PML_IBI  as PML_IBI,
	--lle.PML_BITotal as PML_BITotal,
	--lle.PML_Total  as [PML_Total],		
	ISNULL(lle.PML_BIValue, 0) + ISNULL(lle.PML_IBI, 0) AS PML_BITotal,	
	ISNULL(lle.PML_PDValue, 0) + ISNULL(lle.PML_BIValue, 0)+ ISNULL(lle.PML_IBI, 0) AS PML_Total,
	(lle.PML_LossScenarioSanitised +' || ' +  lle.PML_DescriptionSanitised )as  [PML_Description],
	lle.NLE_Percentage_of_TIV,
	lle.PML_Percentage_of_TIV,
	lle.MPL_Percentage_of_TIV
	FROM 	 LocationNatCatExposure nce
	LEFT JOIN NatCatExposureRating ncr ON ncr.ID=nce.NatCatExposureRatingID
	LEFT JOIN NatCatType nct ON nct.ID=ncr.NatCatTypeID
	LEFT JOIN [Location] l ON nce.LocationID= l.ID
	LEFT JOIN LocationLossEstimate lle ON lle.LocationID=l.ID and lle.LossTypeID=nct.LossTypeID
	
WHERE 	l.LpAcctKey = @LpAcctKey 
	AND l.LpAllPiKey IN ( SELECT lid.ID FROM @LocationIDsList lid )
	AND nct.LossTypeID =@PerilType_Windstorm
		
CREATE TABLE #NatCatOtherNatcat(
		[ID] INT,
		OtherNatcat_LEType INT, 		
		OtherNatcat_Comment_Y_N NVARCHAR(2),
		OtherNatcat_Comment NVARCHAR(MAX),
		NLE_PDPercentage DECIMAL(15,2) NULL,
		NLE_PDValue DECIMAL(30,2) NULL, 
		NLE_BIPercentage DECIMAL(15,2) NULL,
		NLE_BIValue DECIMAL(15,2) NULL,
		NLE_IBI DECIMAL(30,2) NULL,
	    NLE_BITotal DECIMAL(30,2) NULL,
		NLE_Total DECIMAL(30,2) NULL, 
		NLE_Description NVARCHAR(MAX) NULL,
		MPL_PDPercentage DECIMAL(15,2) NULL,
		MPL_PDValue DECIMAL(30,2) NULL, 
		MPL_BIPercentage DECIMAL(15,2) NULL, 
		MPL_BIValue DECIMAL(15,2) NULL,
		MPL_IBI DECIMAL(30,2) NULL,
	    MPL_BITotal DECIMAL(30,2) NULL,
		MPL_Total DECIMAL(30,2) NULL, 
		MPL_Description NVARCHAR(MAX) NULL,
		PML_PDPercentage DECIMAL(15,2) NULL,
		PML_PDValue DECIMAL(30,2) NULL, 
		PML_BIPercentage DECIMAL(15,2) NULL, 
		PML_BIValue DECIMAL(15,2) NULL,
		PML_IBI DECIMAL(30,2) NULL,
	     PML_BITotal DECIMAL(30,2) NULL,
		PML_Total DECIMAL(30,2) NULL, 
		PML_Description NVARCHAR(MAX) NULL,
		NLE_Percentage_of_TIV DECIMAL(15,2) NULL,
		PML_Percentage_of_TIV DECIMAL(15,2) NULL,
		MPL_Percentage_of_TIV DECIMAL(15,2) NULL
		)
INSERT INTO #NatCatOtherNatcat
	SELECT 	
	l.ID,	
	nct.LossTypeID as OtherNatcat_LEType,
	CASE nce.Comment 
	WHEN NULL THEN 'N'
	ELSE 'Y' END as OtherNatcat_Comment_Y_N,	
	nce.Comment as OtherNatcat_Comment,	
	lle.NLE_PDPercentage as NLE_PDPercentage,
	lle.NLE_PDValue as NLE_PDValue,
	lle.NLE_BIPercentage as NLE_BIPercentage,
	lle.NLE_BIValue as NLE_BIValue,
	  lle.NLE_IBI  as  NLE_IBI,
	--   lle.NLE_BITotal  as  NLE_BITotal,
	--lle.NLE_Total  as [NLE_Total],
	ISNULL(lle.NLE_BIValue, 0) + ISNULL(lle.NLE_IBI, 0) AS NLE_BITotal,	
	ISNULL(lle.NLE_PDValue, 0) + ISNULL(lle.NLE_BIValue, 0)+ ISNULL(lle.NLE_IBI, 0) AS [NLE_Total],
	(lle.NLE_LossScenarioSanitised +' || ' +  lle.NLE_DescriptionSanitised )as  [NLE_Description],
	lle.MFL_PDPercentage as MPL_PDPercentage,
	lle.MFL_PDValue as MPL_PDValue,
	lle.MFL_BIPercentage as MPL_BIPercentage,
	lle.MFL_BIValue as MPL_BIValue,
	  lle.MFL_IBI  as  MFL_IBI,
	--   lle.MFL_BITotal  as  MFL_BITotal,
	--lle.MFL_Total  as [MPL_Total],		
	ISNULL(lle.MFL_BIValue, 0) + ISNULL(lle.MFL_IBI, 0) AS MPL_BITotal,		
	ISNULL(lle.MFL_PDValue, 0) + ISNULL(lle.MFL_BIValue, 0)+ ISNULL(lle.MFL_IBI, 0) AS [MPL_Total],
	(lle.MFL_LossScenarioSanitised +' || ' +  lle.MFL_DescriptionSanitised )as  [MPL_Description],
	lle.PML_PDPercentage as PML_PDPercentage,
	lle.PML_PDValue as PML_PDValue,
	lle.PML_BIPercentage as PML_BIPercentage,
	lle.PML_BIValue as PML_BIValue,
	  lle.PML_IBI  as  PML_IBI,
	   lle.PML_BITotal  as  PML_BITotal,
	lle.PML_Total  as [PML_Total],			
	(lle.PML_LossScenarioSanitised +' || ' +  lle.PML_DescriptionSanitised )as  [PML_Description],
	lle.NLE_Percentage_of_TIV,
	lle.PML_Percentage_of_TIV,
	lle.MPL_Percentage_of_TIV

	FROM 	 LocationNatCatExposure nce
	LEFT JOIN NatCatExposureRating ncr ON ncr.ID=nce.NatCatExposureRatingID
	LEFT JOIN NatCatType nct ON nct.ID=ncr.NatCatTypeID
	LEFT JOIN [Location] l ON nce.LocationID= l.ID
	LEFT JOIN LocationLossEstimate lle ON lle.LocationID=l.ID and lle.LossTypeID=nct.LossTypeID
	
WHERE 	l.LpAcctKey = @LpAcctKey 
	AND l.LpAllPiKey IN ( SELECT lid.ID FROM @LocationIDsList lid )
	AND nct.LossTypeID =@PerilType_Other

CREATE TABLE #NatCatPhoto([ID] INT,Photo_Count INT,NatCatPhotoID NVARCHAR(255)) 
INSERT INTO #NatCatPhoto
	SELECT 	
		l.ID,	
		COUNT(*) as Photo_Count,
		STUFF ((SELECT DISTINCT ',' + CAST(ID AS VARCHAR(MAX)) FROM LocationNatCatPhoto lnp2 WHERE lnp2.LocationID = lnp1.LocationID   FOR XML PATH('')),1,1,'')  as NatCatPhotoID
	FROM 	LocationNatCatPhoto lnp1
	LEFT JOIN [Location] l ON lnp1.LocationID= l.ID		
WHERE 	l.LpAcctKey = @LpAcctKey 
	AND l.LpAllPiKey IN ( SELECT lid.ID FROM @LocationIDsList lid )
		group by l.ID,lnp1.LocationID

CREATE TABLE #PermittedLocationsOrderedByTIV([LPAllPiKey] INT, [TIV] BIGINT, [Rank] INT ) 
INSERT INTO #PermittedLocationsOrderedByTIV
	SELECT 	
	l.LPAllPiKey,
	l.PDValue + l.BIValue as [TIV],
	ROW_NUMBER() OVER ( ORDER BY l.PDValue + l.BIValue DESC) AS [Rank] 	
	FROM dbo.[Location] l
	WHERE 	l.LpAcctKey = @LpAcctKey 
	AND l.ID IN (
		select distinct ID from #NatCatWind
		union
		select distinct ID from #NatCatFlood  
		union
		select distinct ID from #NatCatEQ	 
	  ) 

CREATE TABLE #Top0To25Tiv([LPAllPiKey] INT, [TIV] BIGINT, [Rank] INT) 
INSERT INTO #Top0To25Tiv	
	SELECT
		l.LPAllPiKey,
		l.TIV,
		l.[Rank]
		FROM #PermittedLocationsOrderedByTIV l
		WHERE l.[Rank] >= 1 AND l.[Rank] <= ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByTIV) / 4) -- i.e. Row 1 to 25

CREATE TABLE #Top26To50Tiv([LPAllPiKey] INT, [TIV] BIGINT, [Rank] INT) 
INSERT INTO #Top26To50Tiv
		SELECT
		l.LPAllPiKey,
		l.TIV,
		l.[Rank]
		FROM #PermittedLocationsOrderedByTIV l
		WHERE l.[Rank] > ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByTIV) / 4) AND l.[Rank] <= ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByTIV) / 2) -- i.e. Row 26 to 50

CREATE TABLE #Top51To75Tiv([LPAllPiKey] INT, [TIV] BIGINT, [Rank] INT) 
INSERT INTO #Top51To75Tiv
		SELECT
		l.LPAllPiKey,
		l.TIV,
		l.[Rank]
		FROM #PermittedLocationsOrderedByTIV l
		WHERE l.[Rank] > ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByTIV) /2) AND l.[Rank] <= ( ((SELECT COUNT(*) FROM #PermittedLocationsOrderedByTIV) / 4) * 3) -- i.e. Row 51 to 75

CREATE TABLE #Top76To100Tiv([LPAllPiKey] INT, [TIV] BIGINT, [Rank] INT) 
INSERT INTO #Top76To100Tiv
		SELECT
		l.LPAllPiKey,
		l.TIV,
		l.[Rank]
		FROM #PermittedLocationsOrderedByTIV l
		WHERE 
		l.LPAllPiKey NOT IN (SELECT LPAllPiKey FROM #Top0To25Tiv)
		AND
		l.LPAllPiKey NOT IN (SELECT LPAllPiKey FROM #Top26To50Tiv)
		AND
		l.LPAllPiKey NOT IN (SELECT LPAllPiKey FROM #Top51To75Tiv)


CREATE TABLE #PermittedLocationsOrderedByNLE([ID] INT, [NLE] BIGINT, [Rank] INT ) 
INSERT INTO #PermittedLocationsOrderedByNLE	
	select  
	l.ID,
	ISNULL(eq.NLE_Total,0) + ISNULL(fl.NLE_Total,0) +ISNULL(wn.NLE_Total,0)  as [NLE],
	ROW_NUMBER() OVER ( ORDER BY ISNULL(eq.NLE_Total,0) + ISNULL(fl.NLE_Total,0) +ISNULL(wn.NLE_Total,0) DESC) AS [Rank] 	
	FROM #NatCatEQ fl
	LEFT JOIN [Location] l on l.ID=fl.ID
	LEFT JOIN [#NatCatFlood] eq on eq.ID=l.ID
	LEFT JOIN [#NatCatWind] Wn	on wn.id=l.ID
	LEFT JOIN [#NatCatOtherNatcat] onc	on onc.id=l.ID

CREATE TABLE #Highest10NLE([ID] INT, [NLE] BIGINT, [Rank] INT) 
INSERT INTO #Highest10NLE
		SELECT TOP 10
		l.ID,
		l.[NLE],
		l.[Rank]
		FROM #PermittedLocationsOrderedByNLE l
		ORDER BY l.Rank 

CREATE TABLE #Top0To25NLE([ID] INT, [NLE] BIGINT, [Rank] INT)
INSERT INTO #Top0To25NLE
		SELECT
		l.ID,
		l.[NLE],
		l.[Rank]
		FROM #PermittedLocationsOrderedByNLE l
		WHERE l.[Rank] >= 1 AND l.[Rank] <= ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByNLE) / 4) -- i.e. Row 1 to 25

CREATE TABLE #Top26To50NLE([ID] INT, [NLE] BIGINT, [Rank] INT)
INSERT INTO #Top26To50NLE
		SELECT
		l.[ID],
		l.[NLE],
		l.[Rank]
		FROM #PermittedLocationsOrderedByNLE l
		WHERE l.[Rank] > ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByNLE) / 4) AND l.[Rank] <= ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByNLE) / 2) -- i.e. Row 26 to 50

CREATE TABLE #Top51To75NLE([ID] INT, [NLE] BIGINT, [Rank] INT)
INSERT INTO #Top51To75NLE
		SELECT
		l.[ID],
		l.[NLE],
		l.[Rank]
		FROM #PermittedLocationsOrderedByNLE l
		WHERE l.[Rank] > ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByNLE) /2) AND l.[Rank] <= ( ((SELECT COUNT(*) FROM #PermittedLocationsOrderedByNLE) / 4) * 3) -- i.e. Row 51 to 75

CREATE TABLE #Top76To100NLE([ID] INT, [NLE] BIGINT, [Rank] INT)
INSERT INTO #Top76To100NLE
		SELECT
		l.[ID],
		l.NLE,
		l.[Rank]
		FROM #PermittedLocationsOrderedByNLE l
		WHERE 
		l.[ID] NOT IN (SELECT [ID] FROM #Top0To25NLE)
		AND
		l.[ID] NOT IN (SELECT [ID] FROM #Top26To50NLE)
		AND
		l.[ID] NOT IN (SELECT [ID] FROM #Top51To75NLE)

CREATE TABLE #PermittedLocationsOrderedByPML([ID] INT, [PML] BIGINT, [Rank] INT)
INSERT INTO #PermittedLocationsOrderedByPML
	SELECT  
	l.ID,
	ISNULL(eq.PML_Total,0) + ISNULL(fl.PML_Total,0) +ISNULL(wn.PML_Total,0)  as [PML],
	ROW_NUMBER() OVER ( ORDER BY ISNULL(eq.PML_Total,0) + ISNULL(fl.PML_Total,0) +ISNULL(wn.PML_Total,0) DESC) AS [Rank] 	
	FROM #NatCatEQ fl
	LEFT JOIN Location l on l.ID=fl.ID
	LEFT JOIN #NatCatFlood eq on eq.ID=l.ID
	LEFT JOIN #NatCatWind Wn	on wn.id=l.ID
	LEFT JOIN [#NatCatOtherNatcat] onc	on onc.id=l.ID

CREATE TABLE #Highest10PML([ID] INT, [PML] BIGINT, [Rank] INT)
INSERT INTO #Highest10PML
		SELECT TOP 10
		l.ID,
		l.[PML],
		l.[Rank]
		FROM #PermittedLocationsOrderedByPML l
		order by l.Rank 

CREATE TABLE #Top0To25PML([ID] INT, [PML] BIGINT, [Rank] INT)
INSERT #Top0To25PML 
		SELECT
		l.[ID],
		l.[PML],
		l.[Rank]
		FROM #PermittedLocationsOrderedByPML l
		WHERE l.[Rank] >= 1 AND l.[Rank] <= ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByPML) / 4) -- i.e. Row 1 to 25
		
CREATE TABLE #Top26To50PML([ID] INT, [PML] BIGINT, [Rank] INT)
INSERT INTO #Top26To50PML
		SELECT
		l.[ID],
		l.[PML],
		l.[Rank]
		FROM #PermittedLocationsOrderedByPML l
		WHERE l.[Rank] > ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByPML) / 4) AND l.[Rank] <= ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByPML) / 2) -- i.e. Row 26 to 50

CREATE TABLE #Top51To75PML([ID] INT, [PML] BIGINT, [Rank] INT)
INSERT INTO #Top51To75PML
		SELECT
		l.[ID],
		l.[PML],
		l.[Rank]
		FROM #PermittedLocationsOrderedByPML l
		WHERE l.[Rank] > ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByPML) /2) AND l.[Rank] <= ( ((SELECT COUNT(*) FROM #PermittedLocationsOrderedByPML) / 4) * 3) -- i.e. Row 51 to 75

CREATE TABLE #Top76To100PML([ID] INT, [PML] BIGINT, [Rank] INT)
INSERT INTO #Top76To100PML
		SELECT
		l.[ID],
		l.PML,
		l.[Rank]
		FROM #PermittedLocationsOrderedByPML l
		WHERE 
		l.[ID] NOT IN (SELECT [ID] FROM #Top0To25PML)
		AND
		l.[ID] NOT IN (SELECT [ID] FROM #Top26To50PML)
		AND
		l.[ID] NOT IN (SELECT [ID] FROM #Top51To75PML)


CREATE TABLE #PermittedLocationsOrderedByMPL([ID] INT, [MPL] BIGINT, [Rank] INT) 
INSERT INTO #PermittedLocationsOrderedByMPL
	SELECT 
		l.ID,
		ISNULL(eq.MPL_Total,0) + ISNULL(fl.MPL_Total,0) +ISNULL(wn.MPL_Total,0)  as [MPL],
		ROW_NUMBER() OVER ( ORDER BY ISNULL(eq.MPL_Total,0) + ISNULL(fl.MPL_Total,0) +ISNULL(wn.MPL_Total,0) DESC) AS [Rank] 	
		from #NatCatEQ fl
		LEFT JOIN [Location] l on l.ID=fl.ID
		LEFT JOIN #NatCatFlood eq on eq.ID=l.ID
		LEFT JOIN #NatCatWind Wn	on wn.id=l.ID
		LEFT JOIN [#NatCatOtherNatcat] onc	on onc.id=l.ID

CREATE TABLE #Highest10MPL([ID] INT, [MPL] BIGINT, [Rank] INT) 
INSERT INTO #Highest10MPL
		SELECT TOP 10
		l.ID,
		l.[MPL],
		l.[Rank]
		FROM #PermittedLocationsOrderedByMPL l
		ORDER BY l.Rank 

CREATE TABLE #Top0To25MPL([ID] INT, [MPL] BIGINT, [Rank] INT) 
INSERT INTO #Top0To25MPL
		SELECT
		l.[ID],
		l.[MPL],
		l.[Rank]
		FROM #PermittedLocationsOrderedByMPL l
		WHERE l.[Rank] >= 1 AND l.[Rank] <= ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByMPL) / 4) -- i.e. Row 1 to 25

CREATE TABLE #Top26To50MPL([ID] INT, [MPL] BIGINT, [Rank] INT) 
INSERT INTO #Top26To50MPL
		SELECT
		l.[ID],
		l.[MPL],
		l.[Rank]
		FROM #PermittedLocationsOrderedByMPL l
		WHERE l.[Rank] > ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByMPL) / 4) AND l.[Rank] <= ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByMPL) / 2) -- i.e. Row 26 to 50

CREATE TABLE #Top51To75MPL([ID] INT, [MPL] BIGINT, [Rank] INT) 
INSERT INTO #Top51To75MPL
		SELECT
		l.[ID],
		l.[MPL],
		l.[Rank]
		FROM #PermittedLocationsOrderedByMPL l
		WHERE l.[Rank] > ( (SELECT COUNT(*) FROM #PermittedLocationsOrderedByMPL) /2) AND l.[Rank] <= ( ((SELECT COUNT(*) FROM #PermittedLocationsOrderedByMPL) / 4) * 3) -- i.e. Row 51 to 75

CREATE TABLE #Top76To100MPL([ID] INT, [MPL] BIGINT, [Rank] INT) 
INSERT INTO #Top76To100MPL
		SELECT
		l.[ID],
		l.MPL,
		l.[Rank]
		FROM #PermittedLocationsOrderedByMPL l
		WHERE 
		l.[ID] NOT IN (SELECT [ID] FROM #Top0To25MPL)
		AND
		l.[ID] NOT IN (SELECT [ID] FROM #Top26To50MPL)
		AND
		l.[ID] NOT IN (SELECT [ID] FROM #Top51To75MPL)

		

		INSERT INTO @Matches
		SELECT
			RowNumber = ROW_NUMBER() OVER 
			( 
				ORDER BY
				CASE @SortExpression
				WHEN 'LocationID' THEN 
				CASE @UseLocationNo
				WHEN 1     THEN CONVERT(SQL_VARIANT,[LocationNo])
				WHEN 0      THEN CONVERT(SQL_VARIANT,[LocationCode])
				END										                       
				WHEN  'CustomerLocationID'  THEN CONVERT(SQL_VARIANT,[ClientLocationNo])
				WHEN  'LocationName'  THEN CONVERT(SQL_VARIANT,[LocationName])
				WHEN  'Division'  THEN CONVERT(SQL_VARIANT,DivisionName)
				WHEN  'SubDivision'  THEN CONVERT(SQL_VARIANT,SubDivisionName)
				WHEN  'StreetAddress1'  THEN CONVERT(SQL_VARIANT,[AddressLine1])
				WHEN  'StreetAddress2' THEN CONVERT(SQL_VARIANT,[AddressLine2])
				WHEN  'City'  THEN CONVERT(SQL_VARIANT,[City])
				WHEN  'State'  THEN CONVERT(SQL_VARIANT,[State])
				WHEN  'Country'  THEN CONVERT(SQL_VARIANT,[Country])
				WHEN  'TotalProperty' THEN CONVERT(SQL_VARIANT,[Total Property])
				WHEN  'BusinessInterruption'  THEN CONVERT(SQL_VARIANT,[Business Interruption])
				WHEN  'TotalInsurableValue'  THEN CONVERT(SQL_VARIANT,[Total Insurable Value])
				--Location Values at Last Survey
				WHEN  'LastSurveyDate'  THEN CONVERT(SQL_VARIANT,[LastSurveyDate])
				WHEN  'PDValue_AtLastSurvey'  THEN CONVERT(SQL_VARIANT,[PDValue_AtLastSurvey])
				WHEN  'BIValue_AtLastSurvey'  THEN CONVERT(SQL_VARIANT,[BIValue_AtLastSurvey])
				WHEN  'LocationValue_AtLastSurvey'  THEN CONVERT(SQL_VARIANT,[LocationValue_AtLastSurvey])
				WHEN  'LocationValue_UsedAtLastSurvey'  THEN CONVERT(SQL_VARIANT,[LossEstimatesAlignedToCurrentValues])
				--Earthquake
				WHEN  'ATCEarthquakeZone'  THEN CONVERT(SQL_VARIANT,[ATC Earthquake Zone])
				WHEN  'EarthquakeHazardRating'  THEN CONVERT(SQL_VARIANT,[Earthquake Hazard Rating])
				WHEN  'EarthquakeComment'  THEN CONVERT(NVARCHAR(4000), [Earthquake Comment])
				WHEN  'BuildingType'  THEN CONVERT(SQL_VARIANT,[Building Type])
				WHEN  'SoilConditions'   THEN CONVERT(SQL_VARIANT,[Soil Conditions])
				WHEN  'BuildingIrregularities'  THEN CONVERT(SQL_VARIANT,[Building Irregularities])
				WHEN  'EarthquakeSprinklerBracing'  THEN CONVERT(SQL_VARIANT,[Earthquake Sprinkler Bracing])
				WHEN  'EarthquakeSprinklerBracingComments'  THEN CONVERT(NVARCHAR(4000),[Earthquake Sprinkler Bracing Comments])
				WHEN  'EQ_NLE_PD' THEN CONVERT(SQL_VARIANT,EQ_NLE_PDPercentage)
				WHEN  'EQ_NLE_PDAmount' THEN CONVERT(SQL_VARIANT,EQ_NLE_PDValue)
				WHEN  'EQ_NLE_BI' THEN CONVERT(SQL_VARIANT,EQ_NLE_BIPercentage)
				WHEN  'EQ_NLE_BIAmount' THEN CONVERT(SQL_VARIANT,EQ_NLE_BIValue)
				WHEN  'EQ_NLE_IBI' THEN CONVERT(SQL_VARIANT,EQ_NLE_IBI)
				WHEN  'EQ_NLE_BITotal' THEN CONVERT(SQL_VARIANT,EQ_NLE_BITotal)
				WHEN  'EQ_NLETotal' THEN CONVERT(SQL_VARIANT,EQ_NLE_Total)
				WHEN  'EQ_NLEofTIV' THEN CONVERT(SQL_VARIANT,[EQ_NLE % of TIV Value])
				WHEN  'EQ_NLEScenarioDescription'  THEN CONVERT(NVARCHAR(4000),[EQ_NLE Description])
				WHEN  'EQ_PMLPdPercentage' THEN CONVERT(SQL_VARIANT,EQ_PML_PDPercentage)
				WHEN  'EQ_PMLPdValue' THEN CONVERT(SQL_VARIANT,EQ_PML_PDValue)
				WHEN  'EQ_PMLBiPercentage' THEN CONVERT(SQL_VARIANT,EQ_PML_BIPercentage)
				WHEN  'EQ_PMLBiValue' THEN CONVERT(SQL_VARIANT,EQ_PML_BIValue)
				WHEN  'EQ_PML_IBI' THEN CONVERT(SQL_VARIANT,EQ_PML_IBI)
				WHEN  'EQ_PML_BITotal' THEN CONVERT(SQL_VARIANT,EQ_PML_BITotal)
				WHEN  'EQ_PMLTotal' THEN CONVERT(SQL_VARIANT,EQ_PML_Total)
				WHEN  'EQ_PMLofTIV' THEN CONVERT(SQL_VARIANT,[EQ_PML % of TIV])
				WHEN  'EQ_PMLDescription'  THEN CONVERT(NVARCHAR(4000),[EQ_PML Scenario/Description])
				WHEN  'EQ_MPLPdPercentage' THEN CONVERT(SQL_VARIANT,EQ_MFL_PDPercentage)
				WHEN  'EQ_MPLPdValue' THEN CONVERT(SQL_VARIANT,EQ_MFL_PDValue)
				WHEN  'EQ_MPLBiPercentage' THEN CONVERT(SQL_VARIANT,EQ_MFL_BIPercentage)
				WHEN  'EQ_MPLBiValue' THEN CONVERT(SQL_VARIANT,EQ_MFL_BIValue)
				WHEN  'EQ_MPL_IBI' THEN CONVERT(SQL_VARIANT,EQ_MPL_IBI)
				WHEN  'EQ_MPL_BITotal' THEN CONVERT(SQL_VARIANT,EQ_MPL_BITotal)
				WHEN  'EQ_MPLTotal' THEN CONVERT(SQL_VARIANT,EQ_MFL_Total)
				WHEN  'EQ_MPLofTIV' THEN CONVERT(SQL_VARIANT,[EQ_MPL % of TIV])
				WHEN  'EQ_MPLDescription'  THEN CONVERT(NVARCHAR(4000),[EQ_MPL Scenario/Description])
				--Flood
				WHEN  'FEMAFloodZone'  THEN CONVERT(NVARCHAR(4000),[FEMA Flood Zone])
				WHEN  'FloodHazardRating'  THEN CONVERT(NVARCHAR(4000),[Flood Hazard Rating])
				WHEN  'FloodHazardComment'  THEN CONVERT(NVARCHAR(4000),[Flood Hazard Comment])
				WHEN  'LowestFinishedFloorElevation'  THEN CONVERT(NVARCHAR(4000),[Flood Hazard Comment])
				WHEN  'HundredYearFloodElevation'  THEN CONVERT(NVARCHAR(4000),HundredYearFloodElevation)
				WHEN  'HundredYearFloodElevationComments'  THEN CONVERT(NVARCHAR(4000),HundredYearFloodElevationComments)
				WHEN  'FloodProtectionPresent'  THEN CONVERT(NVARCHAR(4000),[Flood Protection Present])
				WHEN  'FloodProtectionPresentComments'  THEN CONVERT(NVARCHAR(4000),[Flood Protection Present Comments])
				WHEN  'FL_NLE_PD' THEN CONVERT(SQL_VARIANT,FL_NLE_PDPercentage)
				WHEN  'FL_NLE_PDAmount' THEN CONVERT(SQL_VARIANT,FL_NLE_PDValue)
				WHEN  'FL_NLE_BI' THEN CONVERT(SQL_VARIANT,FL_NLE_BIPercentage)				
				WHEN  'FL_NLE_BIAmount' THEN CONVERT(SQL_VARIANT,FL_NLE_BIValue)
				WHEN  'FL_NLE_IBI' THEN CONVERT(SQL_VARIANT,FL_NLE_IBI)
				WHEN  'FL_NLE_BITotal' THEN CONVERT(SQL_VARIANT,FL_NLE_BITotal)
				WHEN  'FL_NLETotal' THEN CONVERT(SQL_VARIANT,FL_NLE_Total)
				WHEN  'FL_NLEofTIV' THEN CONVERT(SQL_VARIANT,[FL_NLE % of TIV Value])
				WHEN  'FL_NLEScenarioDescription'  THEN CONVERT(NVARCHAR(4000),[FL_NLE Description])
				WHEN  'FL_PMLPdPercentage' THEN CONVERT(SQL_VARIANT,FL_PML_PDPercentage)
				WHEN  'FL_PMLPdValue' THEN CONVERT(SQL_VARIANT,FL_PML_PDValue)
				WHEN  'FL_PMLBiPercentage' THEN CONVERT(SQL_VARIANT,FL_PML_BIPercentage)
				WHEN  'FL_PMLBiValue' THEN CONVERT(SQL_VARIANT,FL_PML_BIValue)
				WHEN  'FL_PML_IBI' THEN CONVERT(SQL_VARIANT,FL_PML_IBI)
				WHEN  'FL_PML_BITotal' THEN CONVERT(SQL_VARIANT,FL_PML_BITotal)
				WHEN  'FL_PMLTotal' THEN CONVERT(SQL_VARIANT,FL_PML_Total)
				WHEN  'FL_PMLofTIV' THEN CONVERT(SQL_VARIANT,[FL_PML % of TIV])
				WHEN  'FL_PMLDescription'  THEN CONVERT(NVARCHAR(4000),[FL_PML Scenario/Description])
				WHEN  'FL_MPLPdPercentage' THEN CONVERT(SQL_VARIANT,FL_MFL_PDPercentage)
				WHEN  'FL_MPLPdValue' THEN CONVERT(SQL_VARIANT,FL_MFL_PDValue)
				WHEN  'FL_MPLBiPercentage' THEN CONVERT(SQL_VARIANT,FL_MFL_BIPercentage)
				WHEN  'FL_MPLBiValue' THEN CONVERT(SQL_VARIANT,FL_MFL_BIValue)
				WHEN  'FL_MPL_IBI' THEN CONVERT(SQL_VARIANT,FL_MPL_IBI)
				WHEN  'FL_MPL_BITotal' THEN CONVERT(SQL_VARIANT,FL_MPL_BITotal)
				WHEN  'FL_MPLTotal' THEN CONVERT(SQL_VARIANT,FL_MFL_Total)
				WHEN  'FL_MPLofTIV' THEN CONVERT(SQL_VARIANT,[FL_MPL % of TIV])
				WHEN  'FL_MPLDescription'  THEN CONVERT(NVARCHAR(4000),[FL_MPL Scenario/Description])
				--Wind
				WHEN  'WindStormZone'  THEN CONVERT(NVARCHAR(4000),[Wind Storm Zone])
				WHEN  'WindstormHazardRating'  THEN CONVERT(NVARCHAR(4000),[Windstorm Hazard Rating])
				WHEN  'WindstormHazardComment'  THEN CONVERT(NVARCHAR(4000),[Windstorm Hazard Comment])
				WHEN  'WindExposedSite'  THEN CONVERT(NVARCHAR(4000),[Wind Exposed Site])
				WHEN  'PredominantRoofConstruction'  THEN CONVERT(NVARCHAR(4000),[Predominant Roof Construction])
				WHEN  'Vulnerabilityofcontentstowaterdamage'  THEN CONVERT(NVARCHAR(4000),[Vulnerability of contents to water damage])
				WHEN  'BuildingOpenings'  THEN CONVERT(NVARCHAR(4000),[Building Openings])
				WHEN  'SeaDistance'  THEN CONVERT(NVARCHAR(4000),[Sea Distance])
				WHEN  'SeaDistanceComments'  THEN CONVERT(NVARCHAR(4000),[Sea Distance Comments])
				WHEN  'WIN_NLE_PD' THEN CONVERT(SQL_VARIANT,WIN_NLE_PDPercentage)
				WHEN  'WIN_NLE_PDAmount' THEN CONVERT(SQL_VARIANT,WIN_NLE_PDValue)
				WHEN  'WIN_NLE_BI' THEN CONVERT(SQL_VARIANT,WIN_NLE_BIPercentage)
				WHEN  'WIN_NLE_BIAmount' THEN CONVERT(SQL_VARIANT,WIN_NLE_BIValue)
				WHEN  'WIN_NLE_IBI' THEN CONVERT(SQL_VARIANT,WIN_NLE_IBI)
				WHEN  'WIN_NLE_BITotal' THEN CONVERT(SQL_VARIANT,WIN_NLE_BITotal)
				WHEN  'WIN_NLETotal' THEN CONVERT(SQL_VARIANT,WIN_NLE_Total)
				WHEN  'WIN_NLEofTIV' THEN CONVERT(SQL_VARIANT,[WIN_NLE % of TIV Value])
				WHEN  'WIN_NLEScenarioDescription'  THEN CONVERT(NVARCHAR(4000),[WIN_NLE Description])
				WHEN  'WIN_PMLPdPercentage' THEN CONVERT(SQL_VARIANT,WIN_PML_PDPercentage)
				WHEN  'WIN_PMLPdValue' THEN CONVERT(SQL_VARIANT,WIN_PML_PDValue)
				WHEN  'WIN_PMLBiPercentage' THEN CONVERT(SQL_VARIANT,WIN_PML_BIPercentage)
				WHEN  'WIN_PMLBiValue' THEN CONVERT(SQL_VARIANT,WIN_PML_BIValue)
				WHEN  'WIN_PML_IBI' THEN CONVERT(SQL_VARIANT,WIN_PML_IBI)
				WHEN  'WIN_PML_BITotal' THEN CONVERT(SQL_VARIANT,WIN_PML_BITotal)
				WHEN  'WIN_PMLTotal' THEN CONVERT(SQL_VARIANT,WIN_PML_Total)
				WHEN  'WIN_PMLofTIV' THEN CONVERT(SQL_VARIANT,[WIN_PML % of TIV])
				WHEN  'WIN_PMLDescription'  THEN CONVERT(NVARCHAR(4000),[WIN_PML Scenario/Description])
				WHEN  'WIN_MPLPdPercentage' THEN CONVERT(SQL_VARIANT,WIN_MFL_PDPercentage)
				WHEN  'WIN_MPLPdValue' THEN CONVERT(SQL_VARIANT,WIN_MFL_PDValue)
				WHEN  'WIN_MPLBiPercentage' THEN CONVERT(SQL_VARIANT,WIN_MFL_BIPercentage)
				WHEN  'WIN_MPLBiValue' THEN CONVERT(SQL_VARIANT,WIN_MFL_BIValue)
				WHEN  'WIN_MPL_IBI' THEN CONVERT(SQL_VARIANT,WIN_MPL_IBI)
				WHEN  'WIN_MPL_BITotal' THEN CONVERT(SQL_VARIANT,WIN_MPL_BITotal)
				WHEN  'WIN_MPLTotal' THEN CONVERT(SQL_VARIANT,WIN_MFL_Total)
				WHEN  'WIN_MPLofTIV' THEN CONVERT(SQL_VARIANT,[WIN_MPL % of TIV])
				WHEN  'WIN_MPLDescription'  THEN CONVERT(NVARCHAR(4000),[WIN_MPL Scenario/Description])
				--Other Natcat
				WHEN  'OtherNatCat' THEN CONVERT(SQL_VARIANT,[Other Nat Cat (Yes/No)])
				WHEN  'OtherNatCatComments' THEN CONVERT(NVARCHAR(4000),[Other Nat Cat Comments])
				WHEN  'OtherNatcat_NLE_PD' THEN CONVERT(SQL_VARIANT,OtherNatcat_NLE_PDPercentage)
				WHEN  'OtherNatcat_NLE_PDAmount' THEN CONVERT(SQL_VARIANT,OtherNatcat_NLE_PDValue)
				WHEN  'OtherNatcat_NLE_BI' THEN CONVERT(SQL_VARIANT,OtherNatcat_NLE_BIPercentage)
				WHEN  'OtherNatcat_NLE_BIAmount' THEN CONVERT(SQL_VARIANT,OtherNatcat_NLE_BIValue)
				WHEN  'OtherNatcat_NLE_IBI' THEN CONVERT(SQL_VARIANT,OtherNatcat_NLE_IBI)
				WHEN  'OtherNatcat_NLE_BITotal' THEN CONVERT(SQL_VARIANT,OtherNatcat_NLE_BITotal)
				WHEN  'OtherNatcat_NLETotal' THEN CONVERT(SQL_VARIANT,OtherNatcat_NLE_Total)
				WHEN  'OtherNatcat_NLEofTIV' THEN CONVERT(SQL_VARIANT,[OtherNatcat_NLE % of TIV Value])
				WHEN  'OtherNatcat_NLEScenarioDescription'  THEN CONVERT(NVARCHAR(4000),[OtherNatcat_NLE Description])
				WHEN  'OtherNatcat_PMLPdPercentage' THEN CONVERT(SQL_VARIANT,OtherNatcat_PML_PDPercentage)
				WHEN  'OtherNatcat_PMLPdValue' THEN CONVERT(SQL_VARIANT,OtherNatcat_PML_PDValue)
				WHEN  'OtherNatcat_PMLBiPercentage' THEN CONVERT(SQL_VARIANT,OtherNatcat_PML_BIPercentage)
				WHEN  'OtherNatcat_PMLBiValue' THEN CONVERT(SQL_VARIANT,OtherNatcat_PML_BIValue)
				WHEN  'OtherNatcat_PML_IBI' THEN CONVERT(SQL_VARIANT,OtherNatcat_PML_IBI)
				WHEN  'OtherNatcat_PML_BITotal' THEN CONVERT(SQL_VARIANT,OtherNatcat_PML_BITotal)
				WHEN  'OtherNatcat_PMLTotal' THEN CONVERT(SQL_VARIANT,OtherNatcat_PML_Total)
				WHEN  'OtherNatcat_PMLofTIV' THEN CONVERT(SQL_VARIANT,[OtherNatcat_PML % of TIV])
				WHEN  'OtherNatcat_PMLDescription'  THEN CONVERT(NVARCHAR(4000),[OtherNatcat_PML Scenario/Description])
				WHEN  'OtherNatcat_MPLPdPercentage' THEN CONVERT(SQL_VARIANT,OtherNatcat_MFL_PDPercentage)
				WHEN  'OtherNatcat_MPLPdValue' THEN CONVERT(SQL_VARIANT,OtherNatcat_MFL_PDValue)
				WHEN  'OtherNatcat_MPLBiPercentage' THEN CONVERT(SQL_VARIANT,OtherNatcat_MFL_BIPercentage)
				WHEN  'OtherNatcat_MPLBiValue' THEN CONVERT(SQL_VARIANT,OtherNatcat_MFL_BIValue)
				WHEN  'OtherNatcat_MPL_IBI' THEN CONVERT(SQL_VARIANT,OtherNatcat_MPL_IBI)
				WHEN  'OtherNatcat_MPL_BITotal' THEN CONVERT(SQL_VARIANT,OtherNatcat_MPL_BITotal)
				WHEN  'OtherNatcat_MPLTotal' THEN CONVERT(SQL_VARIANT,OtherNatcat_MFL_Total)
				WHEN  'OtherNatcat_MPLofTIV' THEN CONVERT(SQL_VARIANT,[OtherNatcat_MPL % of TIV])
				WHEN  'OtherNatcat_MPLDescription'  THEN CONVERT(NVARCHAR(4000),[OtherNatcat_MPL Scenario/Description])

				--Images
				WHEN  'Images' THEN CONVERT(varchar(100),[Photos/Images])
			
			ELSE CONVERT(SQL_VARIANT,LocationNo)
			END ASC, LocationNo ASC
		),
		    led.ID,
			led.LocationNo,
			led.LocationCode,
			led.ClientLocationNo,
			led.LocationName,
			led.DivisionName,
			led.SubDivisionName,
			led.AddressLine1,
			led.AddressLine2,
			led.City,
			led.[State],
			led.Country,			
			led.[Total Property],
			led.[Business Interruption],
			led.[Total Insurable Value],
			led.LastSurveyDate,
			led.PDValue_AtLastSurvey,
			led.BIValue_AtLastSurvey,
			led.LocationValue_AtLastSurvey,
			led.SumsInsuredUpdatedAfterLastSurvey,
			led.[ATC Earthquake Zone],
			led.[Earthquake Hazard Rating],
			led.[Earthquake Comment],
			led.[Building Type],
			led.[Soil Conditions],
			led.[Building Irregularities],
			led.[Earthquake Sprinkler Bracing],
			led.[Earthquake Sprinkler Bracing Comments],
			led.EQ_NLE_PDPercentage,
			led.EQ_NLE_PDValue,
			led.EQ_NLE_BIPercentage,
			led.EQ_NLE_BIValue,
			led.EQ_NLE_IBI,
			led.EQ_NLE_BITotal,
			led.EQ_NLE_Total,
			led.[EQ_NLE % of TIV Value],
			led.[EQ_NLE Description],
			led.EQ_PML_PDPercentage,
			led.EQ_PML_PDValue,
			led.EQ_PML_BIPercentage,
			led.EQ_PML_BIValue,
			led.EQ_PML_IBI,
			led.EQ_PML_BITotal,
			led.EQ_PML_Total,
			led.[EQ_PML % of TIV],
			led.[EQ_PML Scenario/Description],
			led.EQ_MFL_PDPercentage,
		    led.EQ_MFL_PDValue,
			led.EQ_MFL_BIPercentage,
			led.EQ_MFL_BIValue,
			led.EQ_MPL_IBI,
			led.EQ_MPL_BITotal,
			led.EQ_MFL_Total,
			led.[EQ_MPL % of TIV],
			led.[EQ_MPL Scenario/Description],
		  --Flood
		   led.[FEMA Flood Zone],
		   led.[Flood Hazard Rating],
		   led.[Flood Hazard Comment],
		   led.[Lowest Finished Floor Elevation],
		   led.HundredYearFloodElevation,
		   led.HundredYearFloodElevationComments,
		   led.[Flood Protection Present],
		   led.[Flood Protection Present Comments],
		   led.FL_NLE_PDPercentage,
			led.FL_NLE_PDValue,
			led.FL_NLE_BIPercentage,
			led.FL_NLE_BIValue,
			led.FL_NLE_IBI,
			led.FL_NLE_BITotal,
			led.FL_NLE_Total,
			led.[FL_NLE % of TIV Value],
			led.[FL_NLE Description],
			led.FL_PML_PDPercentage,
			led.FL_PML_PDValue,
			led.FL_PML_BIPercentage,
			led.FL_PML_BIValue,
			led.FL_PML_IBI,
			led.FL_PML_BITotal,
			led.FL_PML_Total,
			led.[FL_PML % of TIV],
			led.[FL_PML Scenario/Description],
			led.FL_MFL_PDPercentage,
		    led.FL_MFL_PDValue,
			led.FL_MFL_BIPercentage,
			led.FL_MFL_BIValue,
			led.FL_MPL_IBI,
			led.FL_MPL_BITotal,
			led.FL_MFL_Total,
			led.[FL_MPL % of TIV],
			led.[FL_MPL Scenario/Description],
			--windstorm
			led.[Wind Storm Zone],
			led.[Windstorm Hazard Rating],
			led.[Windstorm Hazard Comment],
			led.[Wind Exposed Site],
			led.[Predominant Roof Construction] ,
			led.[Vulnerability of contents to water damage],
			led.[Building Openings], 
			led.[Sea Distance],
			led.[Sea Distance Comments],
			led.WIN_NLE_PDPercentage,
			led.WIN_NLE_PDValue,
			led.WIN_NLE_BIPercentage,
			led.WIN_NLE_BIValue,
			led.WIN_NLE_IBI,
			led.WIN_NLE_BITotal,
			led.WIN_NLE_Total,
			led.[WIN_NLE % of TIV Value],
			led.[WIN_NLE Description],
			led.WIN_PML_PDPercentage,
			led.WIN_PML_PDValue,
			led.WIN_PML_BIPercentage,
			led.WIN_PML_BIValue,
			led.WIN_PML_IBI,
			led.WIN_PML_BITotal,
			led.WIN_PML_Total,
			led.[WIN_PML % of TIV],
			led.[WIN_PML Scenario/Description],
			led.WIN_MFL_PDPercentage,
		    led.WIN_MFL_PDValue,
			led.WIN_MFL_BIPercentage,
			led.WIN_MFL_BIValue,
			led.WIN_MPL_IBI,
			led.WIN_MPL_BITotal,
			led.WIN_MFL_Total,
			led.[WIN_MPL % of TIV],
			led.[WIN_MPL Scenario/Description],
	        --Other Natural Catastrophe
			led.[Other Nat Cat (Yes/No)],
			led.[Other Nat Cat Comments],
			led.OtherNatcat_NLE_PDPercentage,
			led.OtherNatcat_NLE_PDValue,
			led.OtherNatcat_NLE_BIPercentage,
			led.OtherNatcat_NLE_BIValue,
			led.OtherNatcat_NLE_IBI,
			led.OtherNatcat_NLE_BITotal,
			led.OtherNatcat_NLE_Total,
			led.[OtherNatcat_NLE % of TIV Value],
			led.[OtherNatcat_NLE Description],
			led.OtherNatcat_PML_PDPercentage,
			led.OtherNatcat_PML_PDValue,
			led.OtherNatcat_PML_BIPercentage,
			led.OtherNatcat_PML_BIValue,
			led.OtherNatcat_PML_IBI,
			led.OtherNatcat_PML_BITotal,
			led.OtherNatcat_PML_Total,
			led.[OtherNatcat_PML % of TIV],
			led.[OtherNatcat_PML Scenario/Description],
			led.OtherNatcat_MFL_PDPercentage,
		    led.OtherNatcat_MFL_PDValue,
			led.OtherNatcat_MFL_BIPercentage,
			led.OtherNatcat_MFL_BIValue,
			led.OtherNatcat_MPL_IBI,
			led.OtherNatcat_MPL_BITotal,
			led.OtherNatcat_MFL_Total,
			led.[OtherNatcat_MPL % of TIV],
			led.[OtherNatcat_MPL Scenario/Description],
			--Photos
			led.[Photos/Images],
			led.LossEstimatesAlignedToCurrentValues
					

			FROM
			(

SELECT 
					--Location Information
					l.ID,
					l.LocationNo,
					l.LocationCode,
					l.[ClientLocationNo],l.Name as [LocationName],d.Name as DivisionName,sd.Name as SubDivisionName,
					l.AddressLine1,l.AddressLine2,l.City,l.State,l.Country,l.PDValue AS 'Total Property',
					l.BIValue AS 'Business Interruption',ISNULL(l.PDValue, 0) + ISNULL(l.BIValue, 0) AS 'Total Insurable Value',
					--Location Values at Last Survey
					l.LastSurveyDate,
					l.PDValue_AtLastSurvey,
					l.BIValue_AtLastSurvey,
					l.LocationValue_AtLastSurvey,
					l.SumsInsuredUpdatedAfterLastSurvey,
					--Earthquake
					nceq.EQ_Zone AS 'ATC Earthquake Zone',
					nceq.EQ_ExpectationLevel AS 'Earthquake Hazard Rating',
					nceq.EQ_Comment AS 'Earthquake Comment',
					lncd.BuildingType  AS 'Building Type',lncd.SoilCondition AS 'Soil Conditions',
					lncd.BuildingIrregularities AS 'Building Irregularities',lncd.EarthquakeSprinklerBracing AS 'Earthquake Sprinkler Bracing',
					lncd.EarthquakeSprinklerBracingComment AS 'Earthquake Sprinkler Bracing Comments',
					ROUND(nceq.NLE_PDPercentage , 2, 1)  AS EQ_NLE_PDPercentage,					
					nceq.NLE_PDValue  AS EQ_NLE_PDValue,
					ROUND(nceq.NLE_BIPercentage , 2, 1)   As  EQ_NLE_BIPercentage,
					nceq.NLE_BIValue AS EQ_NLE_BIValue,	
					nceq.NLE_IBI AS EQ_NLE_IBI,
					nceq.NLE_BITotal AS EQ_NLE_BITotal,			 
					IIF(nceq.NLE_Total = 0,NULL,nceq.NLE_Total)AS EQ_NLE_Total,
					ROUND(nceq.NLE_Percentage_of_TIV , 2, 1)  AS 'EQ_NLE % of TIV Value',	
					CONVERT(nvarchar(4000),nceq.[NLE_Description]) AS 'EQ_NLE Description',
					 ROUND(nceq.PML_PDPercentage , 2, 1) AS EQ_PML_PDPercentage,
					nceq.PML_PDValue  AS EQ_PML_PDValue,
					  ROUND(nceq.PML_BIPercentage , 2, 1)As  EQ_PML_BIPercentage,
					nceq.PML_BIValue AS EQ_PML_BIValue,		
					nceq.PML_IBI AS EQ_PML_IBI,
					nceq.PML_BITotal AS EQ_PML_BITotal,		 
					IIF(nceq.PML_Total = 0,NULL,nceq.PML_Total) AS EQ_PML_Total, 
					 ROUND(nceq.PML_Percentage_of_TIV , 2, 1) AS 'EQ_PML % of TIV',					
					CONVERT(nvarchar(4000),nceq.PML_Description) AS 'EQ_PML Scenario/Description',
				      ROUND(nceq.MPL_PDPercentage , 2, 1) AS EQ_MFL_PDPercentage,
					nceq.MPL_PDValue  AS EQ_MFL_PDValue,
				   ROUND(nceq.MPL_BIPercentage , 2, 1)  As  EQ_MFL_BIPercentage,
					nceq.MPL_BIValue AS EQ_MFL_BIValue,			
					nceq.MPL_IBI AS EQ_MPL_IBI,
					nceq.MPL_BITotal AS EQ_MPL_BITotal,		 
					IIF(nceq.MPL_Total = 0,NULL,nceq.MPL_Total)AS EQ_MFL_Total,
				    ROUND(nceq.MPL_Percentage_of_TIV , 2, 1)   AS 'EQ_MPL % of TIV',					
					CONVERT(nvarchar(4000),nceq.[MPL_Description]) AS 'EQ_MPL Scenario/Description',
	

					--Flood
					ncfl.Flood_Zone AS 'FEMA Flood Zone',
					ncfl.Flood_ExpectationLevel AS 'Flood Hazard Rating',
					ncfl.Flood_Comment AS 'Flood Hazard Comment',
					lncd.LowestFinishedFloorElevation AS 'Lowest Finished Floor Elevation',
					lncd.HundredYearFloodElevation AS HundredYearFloodElevation,
					NULL AS HundredYearFloodElevationComments,
					lncd.FloodProtection AS 'Flood Protection Present',
					lncd.FloodProtectionComment AS 'Flood Protection Present Comments',					
					ROUND(ncfl.NLE_PDPercentage , 2, 1) AS FL_NLE_PDPercentage,
					ncfl.NLE_PDValue  AS FL_NLE_PDValue,
					 ROUND(ncfl.NLE_BIPercentage , 2, 1) As  FL_NLE_BIPercentage,
					ncfl.NLE_BIValue AS FL_NLE_BIValue,	
					ncfl.NLE_IBI AS FL_NLE_IBI,	
					ncfl.NLE_BITotal AS FL_NLE_BITotal,				 
					IIF(ncfl.NLE_Total = 0,NULL,ncfl.NLE_Total)AS FL_NLE_Total,
					ROUND(ncfl.NLE_Percentage_of_TIV , 2, 1) AS 'FL_NLE % of TIV Value',					
					CONVERT(nvarchar(4000),ncfl.[NLE_Description]) AS 'FL_NLE Description',
					ROUND(ncfl.PML_PDPercentage , 2, 1)  AS FL_PML_PDPercentage,
					ncfl.PML_PDValue  AS FL_PML_PDValue,
					ROUND(ncfl.PML_BIPercentage , 2, 1) As  FL_PML_BIPercentage,
					ncfl.PML_BIValue AS FL_PML_BIValue,	
					ncfl.PML_IBI AS FL_PML_IBI,	
					ncfl.PML_BITotal AS FL_PML_BITotal,			 
					IIF(ncfl.PML_Total = 0,NULL,ncfl.PML_Total)AS FL_PML_Total,
					ROUND(ncfl.PML_Percentage_of_TIV , 2, 1)AS 'FL_PML % of TIV',					
					CONVERT(nvarchar(4000),ncfl.PML_Description) AS 'FL_PML Scenario/Description',
				    ROUND(ncfl.MPL_PDPercentage , 2, 1)  AS FL_MFL_PDPercentage,
					ncfl.MPL_PDValue  AS FL_MFL_PDValue,
				    ROUND(ncfl.MPL_BIPercentage , 2, 1)  As  FL_MFL_BIPercentage,
					ncfl.MPL_BIValue AS FL_MFL_BIValue,			
					ncfl.MPL_IBI AS FL_MPL_IBI,	
					ncfl.MPL_BITotal AS FL_MPL_BITotal,	 
					IIF(ncfl.MPL_Total = 0,NULL,ncfl.MPL_Total)AS FL_MFL_Total,
					 ROUND(ncfl.MPL_Percentage_of_TIV , 2, 1)  AS 'FL_MPL % of TIV',					
					CONVERT(nvarchar(4000),ncfl.MPL_Description) AS 'FL_MPL Scenario/Description',
					
					---Wind Storm
					ncwin.Wind_Zone AS 'Wind Storm Zone',
					ncwin.Wind_ExpectationLevel AS 'Windstorm Hazard Rating',
					ncwin.Wind_Comment AS 'Windstorm Hazard Comment',
					lncd.WindExposedSite AS 'Wind Exposed Site',
					lncd.PredominantRoofConstruction AS 'Predominant Roof Construction',
					lncd.VulnerabilityContentsToWaterDamage AS 'Vulnerability of contents to water damage',
					lncd.BuildingOpenings AS 'Building Openings',					
					lncd.SeaDistance AS 'Sea Distance',
					lncd.SeaDistanceComment AS 'Sea Distance Comments',					
					ROUND(ncwin.NLE_PDPercentage , 2, 1)  AS WIN_NLE_PDPercentage,
					ncwin.NLE_PDValue  AS WIN_NLE_PDValue,
					ROUND(ncwin.NLE_BIPercentage , 2, 1)  As  WIN_NLE_BIPercentage,
					ncwin.NLE_BIValue AS WIN_NLE_BIValue,		
					ncwin.NLE_IBI AS WIN_NLE_IBI,	
					ncwin.NLE_BITotal AS WIN_NLE_BITotal,	 		 
					IIF(ncwin.NLE_Total = 0,NULL,ncwin.NLE_Total)AS WIN_NLE_Total,
					ROUND(ncwin.NLE_Percentage_of_TIV , 2, 1)  AS 'WIN_NLE % of TIV Value',					
					CONVERT(nvarchar(4000),ncwin.[NLE_Description]) AS 'WIN_NLE Description',
					ROUND(ncwin.PML_PDPercentage , 2, 1)   AS WIN_PML_PDPercentage,
					ncwin.PML_PDValue  AS WIN_PML_PDValue,
					ROUND(ncwin.PML_BIPercentage , 2, 1) As  WIN_PML_BIPercentage,
					ncwin.PML_BIValue AS WIN_PML_BIValue,		
					ncwin.PML_IBI AS WIN_PML_IBI,	
					ncwin.PML_BITotal AS WIN_PML_BITotal,			 
					IIF(ncwin.PML_Total = 0,NULL,ncwin.PML_Total)AS WIN_PML_Total,
					ROUND(ncwin.PML_Percentage_of_TIV , 2, 1) AS 'WIN_PML % of TIV',					
					CONVERT(nvarchar(4000),ncwin.PML_Description) AS 'WIN_PML Scenario/Description',
					ROUND(ncwin.MPL_PDPercentage , 2, 1)  AS WIN_MFL_PDPercentage,
					ncwin.MPL_PDValue  AS WIN_MFL_PDValue,
					ROUND(ncwin.MPL_BIPercentage , 2, 1) As  WIN_MFL_BIPercentage,
					ncwin.MPL_BIValue AS WIN_MFL_BIValue,	
					ncwin.MPL_IBI AS WIN_MPL_IBI,	
					ncwin.MPL_BITotal AS WIN_MPL_BITotal,			 
					IIF(ncwin.MPL_Total = 0,NULL,ncwin.MPL_Total)AS WIN_MFL_Total,
					ROUND(ncwin.MPL_Percentage_of_TIV , 2, 1)  AS 'WIN_MPL % of TIV',					
					CONVERT(nvarchar(4000),ncwin.MPL_Description) AS 'WIN_MPL Scenario/Description',
					
					--Other Natural Catastrophe
					nconc.OtherNatcat_Comment_Y_N AS 'Other Nat Cat (Yes/No)',
					nconc.OtherNatcat_Comment AS 'Other Nat Cat Comments',
					ROUND(nconc.NLE_PDPercentage , 2, 1)  AS OtherNatcat_NLE_PDPercentage,
					nconc.NLE_PDValue  AS OtherNatcat_NLE_PDValue,
					ROUND(nconc.NLE_BIPercentage , 2, 1) As  OtherNatcat_NLE_BIPercentage,
					nconc.NLE_BIValue AS OtherNatcat_NLE_BIValue,		
					nconc.NLE_IBI AS OtherNatcat_NLE_IBI,	
					nconc.NLE_BITotal AS OtherNatcat_NLE_BITotal,		 
					IIF(nconc.NLE_Total = 0,NULL,nconc.NLE_Total)AS OtherNatcat_NLE_Total,
					nconc.NLE_Percentage_of_TIV AS 'OtherNatcat_NLE % of TIV Value',					
					CONVERT(nvarchar(4000),nconc.[NLE_Description]) AS 'OtherNatcat_NLE Description',
					ROUND(nconc.PML_PDPercentage , 2, 1) AS OtherNatcat_PML_PDPercentage,
					nconc.PML_PDValue  AS OtherNatcat_PML_PDValue,
				    ROUND(nconc.PML_BIPercentage , 2, 1)  As  OtherNatcat_PML_BIPercentage,
					nconc.PML_BIValue AS OtherNatcat_PML_BIValue,	
					nconc.PML_IBI AS OtherNatcat_PML_IBI,	
					nconc.PML_BITotal AS OtherNatcat_PML_BITotal,				 
					IIF(nconc.PML_Total = 0,NULL,nconc.PML_Total)AS OtherNatcat_PML_Total,
					ROUND(nconc.PML_Percentage_of_TIV , 2, 1)  AS 'OtherNatcat_PML % of TIV',					
					CONVERT(nvarchar(4000),nconc.PML_Description) AS 'OtherNatcat_PML Scenario/Description',
					ROUND(nconc.MPL_PDPercentage , 2, 1)   AS OtherNatcat_MFL_PDPercentage,
					nconc.MPL_PDValue  AS OtherNatcat_MFL_PDValue,
					ROUND(nconc.MPL_BIPercentage , 2, 1)  As  OtherNatcat_MFL_BIPercentage,
					nconc.MPL_BIValue AS OtherNatcat_MFL_BIValue,		
					nconc.MPL_IBI AS OtherNatcat_MPL_IBI,	
					nconc.MPL_BITotal AS OtherNatcat_MPL_BITotal,			 
					IIF(nconc.MPL_Total = 0,NULL,nconc.MPL_Total)AS OtherNatcat_MFL_Total,
					ROUND(nconc.MPL_Percentage_of_TIV , 2, 1) AS 'OtherNatcat_MPL % of TIV',					
					CONVERT(nvarchar(4000),nconc.MPL_Description) AS 'OtherNatcat_MPL Scenario/Description',

					--Photos
					ncp.NatCatPhotoID AS 'Photos/Images',
					
					l.LEsAlignedWithin5Percent AS LossEstimatesAlignedToCurrentValues

					FROM 	 LocationNatCatExposure nce
						LEFT JOIN NatCatExposureRating ncr ON ncr.ID=nce.NatCatExposureRatingID
						LEFT JOIN NatCatType nct ON nct.ID=ncr.NatCatTypeID
						LEFT JOIN [Location] l ON nce.LocationID= l.ID
						LEFT JOIN LocationNatCatDetail lncd on lncd.LocationID=l.ID
						LEFT JOIN #NatCatPhoto ncp on ncp.ID=l.ID											

						LEFT JOIN #NatCatEQ nceq on nceq.ID = l.ID
						LEFT JOIN #NatCatFlood ncfl on ncfl.ID = l.ID
						LEFT JOIN #NatCatWind ncwin on ncwin.ID = l.ID
						LEFT JOIN [#NatCatOtherNatcat] nconc on nconc.ID=l.ID
				
						LEFT JOIN [Division] d on d.ID = l.DivisionID
						LEFT JOIN [SubDivision] sd on sd.ID = l.SubDivisionID
						LEFT JOIN PredominantConstructionType construction on construction.ID = l.PredominantConstructionTypeID				
		
						

				WHERE 				
				nct.LossTypeID in (3,4,5,6) AND

				 l.AccountID = @AccountID  
					 
				 AND
			   (l.LPAllPiKey IN (SELECT ID FROM @LocationIDsList))
			  AND
		--	 BEGIN Apply Location TIV filter
	(
		(
		@TivFiter_Top0to25 IN (SELECT ID FROM @TIVQuartilesFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top0To25Tiv))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top0To25Tiv) )
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top0To25Tiv))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top0To25Tiv))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top0To25Tiv))
			) 
		)
		OR
		(
		@TivFiter_Top26to50 IN (SELECT ID FROM @TIVQuartilesFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top26To50Tiv))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top26To50Tiv) )
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top26To50Tiv))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top26To50Tiv))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top26To50Tiv))
			) 
		)
		OR
		(
		@TivFiter_Top51to75 IN (SELECT ID FROM @TIVQuartilesFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top51To75Tiv))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top51To75Tiv) )
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top51To75Tiv))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top51To75Tiv))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top51To75Tiv))
			)
		)
		OR
		(
		@TivFiter_Top76to100 IN (SELECT ID FROM @TIVQuartilesFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top76To100Tiv))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top76To100Tiv))
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top76To100Tiv))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top76To100Tiv))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.LPAllPiKey in (SELECT [LPAllPiKey] FROM #Top76To100Tiv))
			)
		)
		OR (
				@TivFiter_All IN (SELECT ID FROM @TIVQuartilesFilter) 
		)
	) -- END Apply Location TIV filter
	AND
	--	 BEGIN Apply Location NLE filter
	(
		(
		@NleFiter_Highest10 IN (SELECT ID FROM @NLEQuartilesFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Highest10NLE))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Highest10NLE) )
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Highest10NLE))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Highest10NLE))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Highest10NLE))

			) 
		) 									
		OR			
		
		(@NLEFiter_Top0to25 IN (SELECT ID FROM @NLEQuartilesFilter)  AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top0To25NLE))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top0To25NLE) )
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top0To25NLE))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top0To25NLE))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top0To25NLE))				
			) 
		)			
		
		OR
		(
		@NLEFiter_Top26to50 IN (SELECT ID FROM @NLEQuartilesFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top26To50NLE))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top26To50NLE) )
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top26To50NLE))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top26To50NLE))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top26To50NLE))				
			) 
		)
		OR
		(
		@NLEFiter_Top51to75 IN (SELECT ID FROM @NLEQuartilesFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top51To75NLE))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top51To75NLE) )
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top51To75NLE))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top51To75NLE))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top51To75NLE))
			)
		)
		OR
		(
		@NLEFiter_Top76to100 IN (SELECT ID FROM @NLEQuartilesFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top76To100NLE))
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top76To100NLE) )
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top76To100NLE))
			 OR
			 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top76To100NLE))
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top76To100NLE))
			)
		)
		OR (
				@NLEFiter_All IN (SELECT ID FROM @NLEQuartilesFilter) 
		)
	) -- END Apply Location NLE filter
	AND
	--	 BEGIN Apply Location PML filter
	(
		(
				 @PMLFiter_Highest10 IN (SELECT ID FROM @PMLQuartileFilter) AND (
					(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Highest10PML))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Highest10PML) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Highest10PML))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Highest10PML))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Highest10PML))				 
					) 
				) 									
				OR	
				(@PMLFiter_Top0to25 IN (SELECT ID FROM @PMLQuartileFilter) AND (
					(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top0To25PML))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top0To25PML) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top0To25PML))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top0To25PML))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top0To25PML))				
					) 
				)
				OR
				(
				@PMLFiter_Top26to50 IN (SELECT ID FROM @PMLQuartileFilter) AND (
					(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top26To50PML))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top26To50PML) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top26To50PML))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top26To50PML))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top26To50PML))				
					) 
				)
				OR
				(
				@PMLFiter_Top51to75 IN (SELECT ID FROM @PMLQuartileFilter) AND (
					 (@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top51To75PML))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top51To75PML) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top51To75PML))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top51To75PML))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top51To75PML))
					)
				)
				OR
				(
				@PMLFiter_Top76to100 IN (SELECT ID FROM @PMLQuartileFilter) AND (
					(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top76To100PML))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top76To100PML) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top76To100PML))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top76To100PML))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top76To100PML))				
					)
				)
				OR (
						@PMLFiter_All IN (SELECT ID FROM @PMLQuartileFilter) 
				)
	) -- END Apply Location PML filter
	AND
--	 BEGIN Apply Location MPL filter
	(
		(
		        @MplFiter_Highest10 IN (SELECT ID FROM @MPLQuartileFilter) AND (
					 (@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Highest10MPL))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Highest10MPL) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Highest10MPL))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Highest10MPL))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Highest10MPL))

					) 
				) 									
				OR
				(@MPLFiter_Top0to25 IN (SELECT ID FROM @MPLQuartileFilter) AND (
					(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top0To25MPL))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top0To25MPL) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top0To25MPL))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top0To25MPL))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top0To25MPL))

					) 
				)
				OR
				(
				@MPLFiter_Top26to50 IN (SELECT ID FROM @MPLQuartileFilter) AND (
					(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top26To50MPL))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top26To50MPL) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top26To50MPL))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top26To50MPL))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top26To50MPL))

					) 
				)
				OR
				(
				@MPLFiter_Top51to75 IN (SELECT ID FROM @MPLQuartileFilter) AND (
					(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top51To75MPL))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top51To75MPL) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top51To75MPL))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top51To75MPL))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top51To75MPL))
					 
					)
				)
				OR
				(
				@MPLFiter_Top76to100 IN (SELECT ID FROM @MPLQuartileFilter) AND (
				
					(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND l.ID in (SELECT [ID] FROM #Top76To100MPL))
					 OR
					 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and l.ID in (SELECT [ID] FROM #Top76To100MPL) )
					 OR 
					 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND l.ID in (SELECT [ID] FROM #Top76To100MPL))
					 OR
					 (@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other AND l.ID in (SELECT [ID] FROM #Top76To100MPL))
					 OR 
					 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND l.ID in (SELECT [ID] FROM #Top76To100MPL))
					 
					)
				)
				OR (
						@MPLFiter_All IN (SELECT ID FROM @MPLQuartileFilter) 
				)
	) -- END Apply Location MPL filter
	AND
--	 BEGIN Apply Peril Hazard Type  filter
	(
		(
		@PerilHazardRating_Negligible IN (SELECT ID FROM @PerilHazardRatingFilter) AND (
			(@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND nceq.EQ_ExpectationLevel='Negligible')
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and ncwin.Wind_ExpectationLevel='Negligible')
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND ncfl.Flood_ExpectationLevel='Negligible')
			 OR
			(@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other)
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND (nceq.EQ_ExpectationLevel='Negligible' or ncwin.Wind_ExpectationLevel='Negligible' or ncfl.Flood_ExpectationLevel='Negligible'))
			) 
		)
		OR
		(
		@PerilHazardRating_Low IN (SELECT ID FROM @PerilHazardRatingFilter) AND (			
		 
		   
			 (@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND nceq.EQ_ExpectationLevel='Low')
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and ncwin.Wind_ExpectationLevel='Low')
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND ncfl.Flood_ExpectationLevel='Low')
			 OR
			(@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other)
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND (nceq.EQ_ExpectationLevel='Low' or ncwin.Wind_ExpectationLevel='Low' or ncfl.Flood_ExpectationLevel='Low')
			 )
				)											 
		)
		OR
		(
		@PerilHazardRating_Moderate IN (SELECT ID FROM @PerilHazardRatingFilter) AND (

					
		 
		   
			 (@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND nceq.EQ_ExpectationLevel='Moderate')
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and ncwin.Wind_ExpectationLevel='Moderate')
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND ncfl.Flood_ExpectationLevel='Moderate')
			 OR
			(@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other)
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND (nceq.EQ_ExpectationLevel='Moderate' or ncwin.Wind_ExpectationLevel='Moderate' or ncfl.Flood_ExpectationLevel='Moderate')
			 )
															
															) 
		)
		OR
		(
		@PerilHazardRating_High IN (SELECT ID FROM @PerilHazardRatingFilter) AND (			 			
		 
		   
			 (@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND nceq.EQ_ExpectationLevel='High')
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and ncwin.Wind_ExpectationLevel='High')
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND ncfl.Flood_ExpectationLevel='High')
			 OR
			(@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other)
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND (nceq.EQ_ExpectationLevel='High' or ncwin.Wind_ExpectationLevel='High' or ncfl.Flood_ExpectationLevel='High')
			 )

				) 
															
		)
		OR
		(
		@PerilHazardRating_Not_Evaluated IN (SELECT ID FROM @PerilHazardRatingFilter) AND (
			 (@PerilType_Earthquake IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Earthquake AND nceq.EQ_ExpectationLevel='Not Evaluated')
			 OR
			 (@PerilType_Windstorm IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Windstorm and ncwin.Wind_ExpectationLevel='Not Evaluated')
			 OR 
			 (@PerilType_Flood IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Flood AND ncfl.Flood_ExpectationLevel='Not Evaluated')
			 OR
			(@PerilType_Other IN (SELECT ID FROM @PerilType) AND nct.LossTypeID=@PerilType_Other)
			 OR 
			 (@PerilType_ALL IN (SELECT ID FROM @PerilType) AND (nceq.EQ_ExpectationLevel='Not Evaluated' or ncwin.Wind_ExpectationLevel='Not Evaluated' or ncfl.Flood_ExpectationLevel='Not Evaluated')
			 )

			) 
															
		)
		OR (
				@PerilHazardRating_All IN (SELECT ID FROM @PerilHazardRatingFilter) 
		)
	) -- END Apply Peril Hazard Type  filter
		GROUP BY
		                l.ID,
						l.LocationNo,
						l.LocationCode,
						l.[ClientLocationNo],
						l.[Name],
						d.[Name],
						sd.[Name],
						l.AddressLine1,
						l.AddressLine2,
						l.City,l.[State],l.Country,l.PDValue,l.BIValue,
						l.LastSurveyDate,
						l.PDValue_AtLastSurvey,
						l.BIValue_AtLastSurvey,
						l.LocationValue_AtLastSurvey,
						l.SumsInsuredUpdatedAfterLastSurvey,
						l.LEsAlignedWithin5Percent,
						nceq.EQ_Zone,
						nceq.EQ_ExpectationLevel,
						nceq.EQ_Comment,
						nceq.NLE_PDPercentage,
						nceq.NLE_PDValue,
						nceq.NLE_BIPercentage,
						nceq.NLE_BIValue,
						nceq.NLE_IBI,
						nceq.NLE_BITotal,
						nceq.NLE_Total,
						nceq.NLE_Description,
						nceq.PML_PDPercentage,
						nceq.PML_PDValue,
						nceq.PML_BIPercentage,
						nceq.PML_BIValue,
						nceq.PML_IBI,
						nceq.PML_BITotal,
						nceq.PML_Total,
						nceq.PML_Description,
						nceq.MPL_PDPercentage,
						nceq.MPL_PDValue,
						nceq.MPL_BIPercentage,
						nceq.MPL_BIValue,
						nceq.MPL_IBI,
						nceq.MPL_BITotal,
						nceq.MPL_Total,
						nceq.MPL_Description,
						nceq.NLE_Percentage_of_TIV,
						nceq.PML_Percentage_of_TIV,
						nceq.MPL_Percentage_of_TIV,
						ncfl.Flood_Zone,
						ncfl.Flood_ExpectationLevel,
						ncfl.Flood_Comment,
						ncfl.NLE_PDPercentage,
						ncfl.NLE_PDValue,
						ncfl.NLE_BIPercentage,
						ncfl.NLE_BIValue,
						ncfl.NLE_IBI,
						ncfl.NLE_BITotal,
						ncfl.NLE_Total,
						ncfl.NLE_Description,
						ncfl.PML_PDPercentage,
						ncfl.PML_PDValue,
						ncfl.PML_BIPercentage,
						ncfl.PML_BIValue,
						ncfl.PML_IBI,
						ncfl.PML_BITotal,
						ncfl.PML_Total,
						ncfl.PML_Description,
						ncfl.MPL_PDPercentage,
						ncfl.MPL_PDValue,
						ncfl.MPL_BIPercentage,
						ncfl.MPL_BIValue,
						ncfl.MPL_IBI,
						ncfl.MPL_BITotal,
						ncfl.MPL_Total,
						ncfl.MPL_Description,
						ncfl.NLE_Percentage_of_TIV,
						ncfl.PML_Percentage_of_TIV,
						ncfl.MPL_Percentage_of_TIV,
						ncwin.Wind_Zone,
						ncwin.Wind_ExpectationLevel,
						ncwin.Wind_Comment,
						ncwin.NLE_PDPercentage,
						ncwin.NLE_PDValue,
						ncwin.NLE_BIPercentage,
						ncwin.NLE_BIValue,
						ncwin.NLE_IBI,
						ncwin.NLE_BITotal,
						ncwin.NLE_Total,
						ncwin.NLE_Description,
						ncwin.PML_PDPercentage,
						ncwin.PML_PDValue,
						ncwin.PML_BIPercentage,
						ncwin.PML_BIValue,
						ncwin.PML_IBI,
						ncwin.PML_BITotal,
						ncwin.PML_Total,
						ncwin.PML_Description,
						ncwin.MPL_PDPercentage,
						ncwin.MPL_PDValue,
						ncwin.MPL_BIPercentage,
						ncwin.MPL_BIValue,
						ncwin.MPL_IBI,
						ncwin.MPL_BITotal,
						ncwin.MPL_Total,
						ncwin.MPL_Description,
						ncwin.NLE_Percentage_of_TIV,
						ncwin.PML_Percentage_of_TIV,
						ncwin.MPL_Percentage_of_TIV,
						lncd.BuildingType,
						lncd.SoilCondition,
                        lncd.BuildingIrregularities,lncd.EarthquakeSprinklerBracing,
                        lncd.EarthquakeSprinklerBracingComment,
						lncd.LowestFinishedFloorElevation,
					    lncd.HundredYearFloodElevation,					
					    lncd.FloodProtection,
					    lncd.FloodProtectionComment,
						lncd.WindExposedSite,
					    lncd.VulnerabilityContentsToWaterDamage,
					    lncd.BuildingOpenings,					
					    lncd.SeaDistance,
					    lncd.SeaDistanceComment,	
                        ncp.NatCatPhotoID,
						lncd.PredominantRoofConstruction,
						nconc.OtherNatcat_Comment,
						nconc.OtherNatcat_Comment_Y_N,
						nconc.NLE_PDPercentage,
						nconc.NLE_PDValue,
						nconc.NLE_BIPercentage,
						nconc.NLE_BIValue,
						nconc.NLE_IBI,
						nconc.NLE_BITotal,
						nconc.NLE_Total,
						nconc.NLE_Description,
						nconc.PML_PDPercentage,
						nconc.PML_PDValue,
						nconc.PML_BIPercentage,
						nconc.PML_BIValue,
						nconc.PML_IBI,
						nconc.PML_BITotal,
						nconc.PML_Total,
						nconc.PML_Description,
						nconc.MPL_PDPercentage,
						nconc.MPL_PDValue,
						nconc.MPL_BIPercentage,
						nconc.MPL_BIValue,
						nconc.MPL_IBI,
						nconc.MPL_BITotal,
						nconc.MPL_Total,
						nconc.MPL_Description,
						nconc.NLE_Percentage_of_TIV,
						nconc.PML_Percentage_of_TIV,
						nconc.MPL_Percentage_of_TIV
					
	  
		) led
		
		ORDER BY led.LocationNo,led.[Total Insurable Value]
		
     
		--- get the total number of rows before paging
		SELECT 
		@TotalRows = COUNT(*) 
		FROM @Matches

	

	IF @SortDirection = 'ASC'
	BEGIN
		SELECT * 
		FROM @Matches
		WHERE
		RowNumber > @StartRowIndex AND RowNumber <= (@StartRowIndex + (@PageSize))
		ORDER BY RowNumber ASC
	END
	ELSE
	BEGIN
		SELECT *
		FROM @Matches
		WHERE 
		RowNumber >= (@TotalRows-@StartRowIndex-@PageSize+1) AND RowNumber <= (@TotalRows-@StartRowIndex)
		ORDER BY RowNumber DESC
	END

END
GO


