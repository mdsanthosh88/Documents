USE [MA2Data]
GO

/****** Object:  StoredProcedure [dbo].[proc_GetRecommendationData]    Script Date: 5/24/2022 10:11:37 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


/* ======================================================================================================================================  
 Author:		D Macduff
 Description:	Obtains a list of Recommendations and associated historic status history

 Note - What is now known as "Implementation Status" used to be described by the schema as "Recommendation Status". The Recommendation Status
 can be found by examining the current Overall Recommendation Status, from the associated LocationRecommendationHistory table

 See User Story 84636 for more detail - https://xlcatlin.visualstudio.com/AXA%20XL%20Risk%20Engineering/_workitems/edit/84636

 Date			    Author			Description
 May 2020		    D Macduff		Created
 22 June 2020		D Macduff		Updated - Apply filtering logic
 04 Dec 2020		A Page			232939 Changed derivation of RecommendationResponseStatus. Uses func_DeriveRecommendationResponseStatus
									to derive this ID.
 15 Oct 2021		D Macduff		304725 - Performance-based enhancements. The history of the status of each recommendation is now calculated
									in the ETL (as opposed to on-the-fly) in order to remove expensive computation for each execution.
====================================================================================================================================== */
CREATE PROCEDURE [dbo].[proc_GetRecommendationData]
@LpAcctKey INT = 1,
@LocationID INT = NULL,
@UseLocationNo BIT,
@StartRowIndex INT = 1,
@PageSize INT = 999999,
@SortExpression VARCHAR(100) = NULL,
@SortDirection VARCHAR(100) = 'ASC',
@TotalRows INT OUTPUT,
@LocationIDsList dbo.IDsList READONLY,	--Set of Location(s) in current filter context
@LpRecKeyList dbo.IDsList READONLY,	--Set of Recommendations(s) in current data filter context
@SelectedRecommendationIDsList dbo.IDsList READONLY,	--Set of Location(s) in current filter context
@FilterPeril dbo.IDsList READONLY,  
@FilterCategory dbo.IDsList READONLY,  
@FilterType dbo.IDsList READONLY,  
@FilterRecommendationStatus dbo.IDsList READONLY,  
@FilterImplementationStatus dbo.IDsList READONLY,  
@FilterRecommendationResponseStatus dbo.IDsList READONLY,  
@FilterLEPriorToImplementation dbo.IDsList READONLY,  
@FilterEstCostToCompleteCategory dbo.IDsList READONLY,  
@LECategoryUpperThreshold_Low BIGINT,  
@LECategoryUpperThreshold_Medium BIGINT,  
@LECategoryUpperThreshold_High BIGINT,  
@LECategoryLowerThreshold_Critical BIGINT,  
@EstCostToCompleteUpperThreshold_Low BIGINT,  
@EstCostToCompleteUpperThreshold_Medium BIGINT,  
@EstCostToCompleteLowerThreshold_High BIGINT,  
@MachineryBreakdownLpRecSubTypeKey_Threshold_Lower INT,  
@MachineryBreakdownLpRecSubTypeKey_Threshold_Upper INT,  
@NaturalCatastropheLpRecSubTypeKey_Threshold_Lower INT,  
@NaturalCatastropheLpRecSubTypeKey_Threshold_Upper INT,  
@AsAtDate DATETIME,
@IsDrillThru BIT= 0
  
AS  
   
BEGIN  
 SET NOCOUNT ON;  
  
DROP TABLE IF EXISTS #TempLocations   
DROP TABLE IF EXISTS #ImplementationStatusTranslationLookup  
DROP TABLE IF EXISTS #Matches  
DROP TABLE IF EXISTS #MatchesId  
DROP TABLE IF EXISTS #TempReclist  
  
 CREATE TABLE #TempLocations([ID] INT)  
 INSERT INTO #TempLocations  
 SELECT ID FROM @LocationIDsList   
  
   
IF OBJECT_ID('tempdb..#TempReclist') IS NOT NULL DROP TABLE #TempReclist  
SELECT * INTO #TempReclist FROM @LpRecKeyList  
  
   
 CREATE TABLE #ImplementationStatusTranslationLookup([Name] NVARCHAR(40), [ID] INT, [Rank] INT)  
  
 INSERT INTO #ImplementationStatusTranslationLookup  
 SELECT   
 recName AS [RecommendationStatusName],  
 base.ID,  
 ROW_NUMBER() OVER ( ORDER BY recName) AS [Rank]  
 FROM  
 (  
  SELECT  
  r.[name] as recName,  
  r.ID  
  FROM RecommendationStatus r  
 ) base  
 ORDER BY [RecommendationStatusName];  
  
 CREATE TABLE #MatchesId  
  (  
   RowNumber INT PRIMARY KEY,  
   ID INT,  
   IsReturn BIT DEFAULT(0)  
  )  
  
 -- store ALL the (unpaged) results in memory  
 CREATE TABLE #Matches  
(  
  RowNumber INT PRIMARY KEY,  
  ID INT,  
  LocationID INT,  
  LPRecKey INT,  
  LocationName NVARCHAR(75),  
  LocationCode NVARCHAR(10),  
  LocationNo NVARCHAR(9),  
  ClientLocationNo NVARCHAR(75),  
  LPAllPiKey INT NOT NULL,  
  DivisionName NVARCHAR(75),  
  SubDivisionName NVARCHAR(75),  
  AddressLine1 NVARCHAR (45),  
  AddressLine2 NVARCHAR (45),  
  City NVARCHAR(75),  
  [State] NVARCHAR(75),  
  Country NVARCHAR(75),  
  LocationValue BIGINT,  
  PDValue BIGINT,  
  BIValue BIGINT,  
  TotalInsurableValue BIGINT,  
  RecID NVARCHAR(30),  
  OverallRecommendationStatusID INT,  
  RecommendationStatusChangeDate DATETIME NULL,  
  Summary VARCHAR(2000),  
  LineOfBusiness NVARCHAR(100),  
  Peril INT NULL,  
  RecommendationCategoryID INT NULL,  
  RecommendationTypeID INT NULL,  
  RecommendationClientIntentID INT NULL,  
  FacilityComment NVARCHAR(MAX),  
  RecommendationProbabilityID INT,  
  IssuedDate DATETIME,  
  RecommendationSourceID INT,  
  LastSurveyConsultant NVARCHAR(75),  
  LastSurveyDate DATETIME,  
  NextSurveyConsultant NVARCHAR(75),  
  NextSurveyDate DATETIME,  
  [Priority] NVARCHAR(75),  
  EstimatedRiskReduction BIGINT,  
  LossEstimatePriorToImplementation BIGINT,  
  LossEstimatePriorToImplementationCategory NVARCHAR(75),  
  LossEstimateAfterImplementation BIGINT,  
  EstCostToComplete BIGINT,  
  EstimatedCostToCompleteCategory BIGINT,  
  CostBenefitRatio BIGINT,  
  LossScenario NVARCHAR(MAX),  
  RecommendationStatusID INT,  
  RecommendationResponseStatusChangeDate DATETIME NULL,  
  ImplementationStatusChangeDate DATETIME NULL,  
  OverallRecommendationStatusChangeDate DATETIME NULL,
  TargetDate DATETIME,  
  CustomerIntentDescription VARCHAR(MAX) NULL,
  ActualCostToComplete BIGINT,  
  RecAssignedDesigneeEmail NVARCHAR(75),  
  RecResponseDesigneeEmail NVARCHAR(75),  
  MyCommentOne NVARCHAR(2000),  
  MyCommentTwo NVARCHAR(2000),  
  MyCommentThree NVARCHAR(2000),  
  SharedComment NVARCHAR(2000),  
  CurrentImplementationStatusID INT,   
  CurrentRecommendationResponseStatusID INT NULL,
  CompletedDate  DATETIME, 
  DetailedRecommendation  NVARCHAR(MAX) NULL,
  CurrentRecommendationStatusID INT NULL,  
  [RecommendationStatusYearMinusOne] INT NULL,
  [RecommendationStatusYearMinusTwo] INT NULL,
  [RecommendationStatusYearMinusThree] INT NULL,
  [RecommendationStatusYearMinusFour] INT NULL,
  [RecommendationStatusYearMinusFive] INT NULL,
  [ImplementationStatusYearMinusOne] INT NULL,
  [ImplementationStatusYearMinusTwo] INT NULL,
  [ImplementationStatusYearMinusThree] INT NULL,
  [ImplementationStatusYearMinusFour] INT NULL,
  [ImplementationStatusYearMinusFive] INT NULL,
  [RecommendationResponseStatusYearMinusOne] INT NULL,
  [RecommendationResponseStatusYearMinusTwo] INT NULL,
  [RecommendationResponseStatusYearMinusThree] INT NULL,
  [RecommendationResponseStatusYearMinusFour] INT NULL,
  [RecommendationResponseStatusYearMinusFive] INT NULL
  
  
 );  
  -- pseudo constants  
 DECLARE @Filter_All AS INT = -1  
   
 DECLARE @LE_Filter_Blank AS INT = 0  
 DECLARE @LE_Filter_Low AS INT = 1  
 DECLARE @LE_Filter_Medium AS INT = 2  
 DECLARE @LE_Filter_High AS INT = 3  
 DECLARE @LE_Filter_Critical AS INT = 4  
  
 DECLARE @EstCost_Filter_Blank AS INT = 0  
 DECLARE @EstCost_Filter_Low AS INT = 1  
 DECLARE @EstCost_Filter_Medium AS INT = 2  
 DECLARE @EstCost_Filter_High AS INT = 3  
  
 DECLARE @Peril_Filter_Fire AS INT = 1  
 DECLARE @Peril_Filter_MachineryBreakdown AS INT = 2  
 DECLARE @Peril_Filter_NaturalCatastrophe AS INT = 7  
 DECLARE @Peril_Filter_Environment AS INT = 6  
  
 DECLARE @LossType_Filter_Fire AS INT = 1  
 DECLARE @LossType_Filter_MachineryBreakdown AS INT = 2  
 DECLARE @LossType_Filter_NaturalCatastrophe AS INT = 6  
  
 DECLARE @NoPlansOrDisagreeOverallRecommendationStatus AS INT = 2    
 DECLARE @VerifiedCompleteOverallRecommendationStatus AS INT = 3  
 DECLARE @CompletedClientActive AS INT = 5    
 DECLARE @NoPlansOrDisagreeValidated AS INT = -1   
 DECLARE @VerifiedComplete AS INT = 2   
 DECLARE @NoPlansOrDisagreeGrouping INT=-3,  @VerifiedCompleteGrouping INT =-1,  @CompletedClientActiveGrouping INT=-2  
 DECLARE @Filter_Validated_Client varchar(10) = ''
  IF (SELECT COUNT (1) FROM @FilterRecommendationStatus) = 1 and (SELECT COUNT(1) FROM @FilterImplementationStatus) = 1
  BEGIN
	IF EXISTS (SELECT 1 FROM @FilterRecommendationStatus WHERE ID = 2) and EXISTS (SELECT 1 FROM @FilterImplementationStatus WHERE ID = 3)
	BEGIN
		 SET @Filter_Validated_Client = '23'
		 --UPDATE @FilterRecommendationStatus SET ID = -1
	END
END
 
-- Unfiltered page, not drilled to via a tile or chart.
If(@IsDrillThru = 0)
 BEGIN
 INSERT INTO #MatchesId SELECT  
  RowNumber = ROW_NUMBER() OVER   
  (   
   ORDER BY  
   CASE @SortExpression  
    WHEN 'LocationGapsOrAxaID' THEN   
     CASE @UseLocationNo  
     WHEN 1															THEN CONVERT(SQL_VARIANT,[LocationNo])  
     WHEN 0															THEN CONVERT(SQL_VARIANT,[LocationCode])  
    END                                    
   WHEN 'ClientLocationID'											THEN CONVERT(SQL_VARIANT,[ClientLocationNo])  
   WHEN 'LocationName'												THEN CONVERT(SQL_VARIANT,l.[Name])  
   WHEN 'Division'													THEN CONVERT(SQL_VARIANT,d.[Name])  
   WHEN 'SubDivision'												THEN CONVERT(SQL_VARIANT,sd.[Name])  
   WHEN 'StreetAddress1'											THEN CONVERT(SQL_VARIANT,[AddressLine1])  
   WHEN 'StreetAddress2'											THEN CONVERT(SQL_VARIANT,[AddressLine2])  
   WHEN 'City'														THEN CONVERT(SQL_VARIANT,[City])  
   WHEN 'StateProvince'												THEN CONVERT(SQL_VARIANT,[State])  
   WHEN 'Country'													THEN CONVERT(SQL_VARIANT,[Country])  
   WHEN 'PropertyValue'												THEN CONVERT(SQL_VARIANT,[PDValue])  
   WHEN 'BusinessInterruptionValue'									THEN CONVERT(SQL_VARIANT,[BIValue])  
   WHEN 'TotalInsurableValue'										THEN CONVERT(SQL_VARIANT,ISNULL(l.PDValue, 0) + ISNULL(l.BIValue, 0))  
   WHEN 'RecID'														THEN CONVERT(SQL_VARIANT,[RecID])  
   WHEN 'RecommendationStatus'										THEN CONVERT(SQL_VARIANT,( r.OverallRecommendationStatusID))  
   WHEN 'RecommendationSummary'										THEN CONVERT(SQL_VARIANT,[Summary] )  
   WHEN 'LineOfBusiness'											THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'Peril'														THEN CONVERT(SQL_VARIANT,[type].LossTypeID )  
   WHEN 'Category'													THEN CONVERT(SQL_VARIANT,[RecommendationCategoryID] )  
   WHEN 'Type'														THEN CONVERT(SQL_VARIANT,[RecommendationTypeID] )  
   WHEN 'SubType'													THEN CONVERT(SQL_VARIANT,[RecommendationTypeID] )  
   WHEN 'IntentAtTimeOfSurvey'										THEN CONVERT(SQL_VARIANT,[RecommendationClientIntentID] )  
   WHEN 'FacilityComment'											THEN CONVERT(SQL_VARIANT,[LocationID] ) -- TODO: can't convert NVARCHAR(max)  
   WHEN 'Probability'												THEN CONVERT(SQL_VARIANT,[RecommendationProbabilityID] )  
   WHEN 'DateIssued'												THEN CONVERT(SQL_VARIANT,[IssuedDate] )  
   WHEN 'RecommendationSource'										THEN CONVERT(SQL_VARIANT,[RecommendationSourceID] )  
   WHEN 'LastSurveyConsultant'										THEN CONVERT(SQL_VARIANT,[LocationID] )  
   WHEN 'LastSurveyDate'											THEN CONVERT(SQL_VARIANT,l.LastSurveyDate )  
   WHEN 'NextSurveyConsultant'										THEN CONVERT(SQL_VARIANT,l.NextSurveyAssignedTo )  
   WHEN 'NextSurveyDate'											THEN CONVERT(SQL_VARIANT,l.LastSurveyDate )  
   WHEN 'AssignedPriority'											THEN CONVERT(SQL_VARIANT,[Priority] )  
   WHEN 'EstimatedRiskReduction'									THEN CONVERT(SQL_VARIANT,((r.LossEstimateBefore - r.LossEstimateAfter) - r.EstCostToComplete) )  
   WHEN 'LossEstimatePriorToImplementation'							THEN CONVERT(SQL_VARIANT,r.LossEstimateBefore )  
   WHEN 'LossEstimatePriorToImplementationCategory'					THEN CONVERT(SQL_VARIANT,r.LossEstimateBefore )  
   WHEN 'LossEstimateAfterImplementation'							THEN CONVERT(SQL_VARIANT,r.LossEstimateAfter )  
   WHEN 'EstimatedCostToComplete'									THEN CONVERT(SQL_VARIANT,[EstCostToComplete] )  
   WHEN 'EstimatedCostToCompleteCategory'							THEN CONVERT(SQL_VARIANT,[EstCostToComplete] )  
   WHEN 'CostBenefitRatio'											THEN CONVERT(SQL_VARIANT,((ISNULL(r.LossEstimateBefore,0) - ISNULL(r.LossEstimateAfter,0)) / ( CASE r.EstCostToComplete WHEN NULL THEN 1 WHEN 0 THEN 1 ELSE r.EstCostToComplete END)) )  
   WHEN 'LossScenario'												THEN CONVERT(SQL_VARIANT,[LocationID] ) -- TODO: can't convert NVARCHAR(max)  
   --WHEN 'ImplementationStatus'										THEN CONVERT(SQL_VARIANT,[RecommendationStatusID])  
    WHEN 'ImplementationStatus'										
	THEN CONVERT(SQL_VARIANT,case when [RecommendationStatusID] = 1 then 1    
              when  [RecommendationStatusID] = 5 then 2   
              when [RecommendationStatusID] = 4 then 3 
              when [RecommendationStatusID] = 3 then 4
			  when [RecommendationStatusID] = 6 then 5
			  when [RecommendationStatusID] = 2 then 6
			    END) 
   WHEN 'ImplementationStatusChangeDate'							THEN CONVERT(SQL_VARIANT,[RecommendationStatusChangedDate]) -- TODO  
   WHEN 'RecommendationResponseStatusChangeDate'					THEN CONVERT(SQL_VARIANT,[RecommendationResponseStatusChangeDate])  
   WHEN 'TargetDate'												THEN CONVERT(SQL_VARIANT,[TargetDate] )  
   WHEN 'Comments'													THEN CONVERT(SQL_VARIANT,[LocationID] ) -- TODO: can't convert NVARCHAR(max)  
   WHEN 'ActualCostToComplete'										THEN CONVERT(SQL_VARIANT,( SELECT TOP 1 ActCostToComplete FROM RecommendationPermanentData rpd WHERE rpd.LPRecKey = r.LPRecKey AND rpd.LPAllPiKey = r.LPAllPiKey ORDER BY [CreatedDate] DESC))  
   WHEN 'Priority'													THEN CONVERT(SQL_VARIANT,[Priority] )  
   WHEN 'RecommendationResponseDesigneeEmail'						THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'RecommendationAssignedDesigneeEmail'						THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'MyCommentOne'											    THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'MyCommentTwo'											    THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'MyCommentThree'										    THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'SharedComment'												THEN CONVERT(SQL_VARIANT,'' )  
   --WHEN 'CurrentImplementationStatus'							    THEN CONVERT(SQL_VARIANT,[RecommendationStatusID] )
    WHEN 'CurrentImplementationStatus'										
	THEN CONVERT(SQL_VARIANT,case when [RecommendationStatusID] = 1 then 1    
              when  [RecommendationStatusID] = 5 then 2   
              when [RecommendationStatusID] = 4 then 3 
              when [RecommendationStatusID] = 3 then 4
			  when [RecommendationStatusID] = 6 then 5
			  when [RecommendationStatusID] = 2 then 6
			    END) 
   WHEN 'CurrentRecommendationResponseStatus'					    THEN CONVERT(SQL_VARIANT,[RecommendationResponseStatusID] )  
   WHEN 'CurrentRecommendationStatus'							    THEN CONVERT(SQL_VARIANT,(r.OverallRecommendationStatusID ) )  
   WHEN 'CompletedDate'                 				            THEN CONVERT(SQL_VARIANT,[CompletedDate])
   WHEN 'DetailedRecommendation'                 				    THEN CONVERT(SQL_VARIANT,'')
   ELSE CONVERT(SQL_VARIANT, r.LocationID)  
   END ASC, r.LocationID ASC  
  ),    -- Column "Row Number"
  r.ID, -- Column "ID"
  0     -- Column "Is Return"
 FROM Recommendation  r (nolock)  
    
  INNER JOIN [Location] l (nolock) on l.ID = r.LocationID  
  INNER JOIN #TempLocations t (nolock) on t.ID = l.LPAllPiKey  
  INNER JOIN [RecommendationStatus] implementationStatus (nolock) on implementationStatus.ID = r.RecommendationStatusID   
  LEFT JOIN [RecommendationCategory] cat (nolock) on cat.ID = r.RecommendationCategoryID  
  LEFT JOIN [RecommendationType] [type] (nolock) on r.RecommendationTypeID = [type].ID  
  LEFT JOIN [Division] d (nolock) on d.ID = l.DivisionID  
  LEFT JOIN [SubDivision] sd (nolock) on sd.ID = l.SubDivisionID  
  
  WHERE   
  r.LPAcctKey = @LpAcctKey   
  AND  
  (  
   @LocationID IS NULL OR r.LocationID = @LocationID  
  )    
  AND  
  (  
  -- Apply SelectedRecommendationID List  
   @Filter_All  in (SELECT rid.ID FROM @SelectedRecommendationIDsList rid )  
   OR --EXISTS (SELECT rid.ID FROM @SelectedRecommendationIDsList rid WHERE r.LPRecKey = rid.ID and r.LPAcctKey = @LpAcctKey)  
   (  
   r.LPRecKey in (SELECT rid.ID FROM @SelectedRecommendationIDsList rid ) AND r.LPAcctKey = @LpAcctKey  
   )  
  )  
  AND  
  (  
   -- Apply Category Filter  
   @Filter_All IN  (SELECT ID FROM @FilterCategory)  
    OR  
   (  
    r.RecommendationCategoryID IN (SELECT ID FROM @FilterCategory)    
   )  
  )  
  
  AND   
  (  
   -- Apply Type Filter  
   @Filter_All IN  (SELECT ID FROM @FilterType) OR  
  
   (  
    r.RecommendationTypeID IN (SELECT ID FROM @FilterType)    
   )  
  )  
  AND   
  (  
   -- Apply Implementation Status Filter  
   @Filter_All IN  (SELECT ID FROM @FilterImplementationStatus) OR  
  
   (  
			CASE WHEN @Filter_Validated_Client = '23' and r.OverallRecommendationStatusID = 2 
			THEN 3 ELSE r.RecommendationStatusID END IN (SELECT ID FROM @FilterImplementationStatus)

  )) 
  AND   
  (  
   -- Apply Recommendation Status Filter  
   CASE WHEN @Filter_Validated_Client = '23' THEN 2 ELSE @Filter_All END IN  (SELECT ID FROM @FilterRecommendationStatus) OR  
  
   (  
      
	 r.OverallRecommendationStatusID IN (SELECT ID FROM @FilterRecommendationStatus)    
   )  
  )  
  AND   
  (  
   -- Apply Recommendation Status Filter  
   @Filter_All IN  (SELECT ID FROM @FilterRecommendationResponseStatus) OR  
  
   (  
       r.RecommendationResponseStatusID IN (SELECT ID FROM @FilterRecommendationStatus)   
    )  
  )  
  
  AND   
  (  
   -- Apply LE Prior To Complete Category Filter  
   @Filter_All IN  (SELECT ID FROM @FilterLEPriorToImplementation) OR  
  
   (  
     ( @LE_Filter_Blank IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore IS NULL  ) OR  
     ( @LE_Filter_Low IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore <= @LECategoryUpperThreshold_Low  ) OR  
     ( @LE_Filter_Medium IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore > @LECategoryUpperThreshold_Low AND r.LossEstimateBefore <= @LECategoryUpperThreshold_Medium) OR  
     ( @LE_Filter_High IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore > @LECategoryUpperThreshold_Medium AND r.LossEstimateBefore <= @LECategoryUpperThreshold_High) OR  
     ( @LE_Filter_Critical IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore > @LECategoryUpperThreshold_High)  
   )  
  )  
  AND   
  (  
   -- Apply Est Cost To Complete Category Filter  
   @Filter_All IN  (SELECT ID FROM @FilterEstCostToCompleteCategory) OR  
  
   (  
     ( @EstCost_Filter_Blank IN (SELECT ID FROM @FilterEstCostToCompleteCategory) AND r.EstCostToComplete IS NULL  ) OR  
     ( @EstCost_Filter_Low IN (SELECT ID FROM @FilterEstCostToCompleteCategory) AND r.EstCostToComplete <= @EstCostToCompleteUpperThreshold_Low  ) OR  
     ( @EstCost_Filter_Medium IN (SELECT ID FROM @FilterEstCostToCompleteCategory) AND r.EstCostToComplete > @EstCostToCompleteUpperThreshold_Low AND r.EstCostToComplete <= @EstCostToCompleteUpperThreshold_Medium) OR  
     ( @EstCost_Filter_High IN (SELECT ID FROM @FilterEstCostToCompleteCategory) AND r.EstCostToComplete > @EstCostToCompleteUpperThreshold_Medium)   
   )  
  )  
  AND   
  (  
   -- Apply Peril Filter  
   @Filter_All IN  (SELECT ID FROM @FilterPeril) OR  
   (  
     ( @Peril_Filter_Fire  IN (SELECT ID FROM @FilterPeril) and ([type].LossTypeId = @LossType_Filter_Fire))   
     OR  
     ( @Peril_Filter_MachineryBreakdown  IN (SELECT ID FROM @FilterPeril) and ([type].LossTypeID = @LossType_Filter_MachineryBreakdown)) OR  
     ( @Peril_Filter_NaturalCatastrophe  IN (SELECT ID FROM @FilterPeril) and ([type].LossTypeID = @LossType_Filter_NaturalCatastrophe))    
   )  
  )  

  END
  ELSE IF(@IsDrillThru = 1)
  BEGIN
 INSERT INTO #MatchesId SELECT  
  RowNumber = ROW_NUMBER() OVER   
  (   
   ORDER BY  
   CASE @SortExpression  
    WHEN 'LocationGapsOrAxaID' THEN   
     CASE @UseLocationNo  
     WHEN 1															THEN CONVERT(SQL_VARIANT,[LocationNo])  
     WHEN 0															THEN CONVERT(SQL_VARIANT,[LocationCode])  
    END                                    
   WHEN 'ClientLocationID'											THEN CONVERT(SQL_VARIANT,[ClientLocationNo])  
   WHEN 'LocationName'												THEN CONVERT(SQL_VARIANT,l.[Name])  
   WHEN 'Division'													THEN CONVERT(SQL_VARIANT,d.[Name])  
   WHEN 'SubDivision'												THEN CONVERT(SQL_VARIANT,sd.[Name])  
   WHEN 'StreetAddress1'											THEN CONVERT(SQL_VARIANT,[AddressLine1])  
   WHEN 'StreetAddress2'											THEN CONVERT(SQL_VARIANT,[AddressLine2])  
   WHEN 'City'														THEN CONVERT(SQL_VARIANT,[City])  
   WHEN 'StateProvince'												THEN CONVERT(SQL_VARIANT,[State])  
   WHEN 'Country'													THEN CONVERT(SQL_VARIANT,[Country])  
   WHEN 'PropertyValue'												THEN CONVERT(SQL_VARIANT,[PDValue])  
   WHEN 'BusinessInterruptionValue'									THEN CONVERT(SQL_VARIANT,[BIValue])  
   WHEN 'TotalInsurableValue'										THEN CONVERT(SQL_VARIANT,ISNULL(l.PDValue, 0) + ISNULL(l.BIValue, 0))  
   WHEN 'RecID'														THEN CONVERT(SQL_VARIANT,[RecID])  
   WHEN 'RecommendationStatus'										THEN CONVERT(SQL_VARIANT,( r.OverallRecommendationStatusID))  
   WHEN 'RecommendationSummary'										THEN CONVERT(SQL_VARIANT,[Summary] )  
   WHEN 'LineOfBusiness'											THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'Peril'														THEN CONVERT(SQL_VARIANT,[type].LossTypeID )  
   WHEN 'Category'													THEN CONVERT(SQL_VARIANT,[RecommendationCategoryID] )  
   WHEN 'Type'														THEN CONVERT(SQL_VARIANT,[RecommendationTypeID] )  
   WHEN 'SubType'													THEN CONVERT(SQL_VARIANT,[RecommendationTypeID] )  
   WHEN 'IntentAtTimeOfSurvey'										THEN CONVERT(SQL_VARIANT,[RecommendationClientIntentID] )  
   WHEN 'FacilityComment'											THEN CONVERT(SQL_VARIANT,[LocationID] ) -- TODO: can't convert NVARCHAR(max)  
   WHEN 'Probability'												THEN CONVERT(SQL_VARIANT,[RecommendationProbabilityID] )  
   WHEN 'DateIssued'												THEN CONVERT(SQL_VARIANT,[IssuedDate] )  
   WHEN 'RecommendationSource'										THEN CONVERT(SQL_VARIANT,[RecommendationSourceID] )  
   WHEN 'LastSurveyConsultant'										THEN CONVERT(SQL_VARIANT,l.LastSurveyBy )  
   WHEN 'LastSurveyDate'											THEN CONVERT(SQL_VARIANT,l.LastSurveyDate )  
   WHEN 'NextSurveyConsultant'										THEN CONVERT(SQL_VARIANT,l.NextSurveyAssignedTo )  
   WHEN 'NextSurveyDate'											THEN CONVERT(SQL_VARIANT,l.LastSurveyDate )  
   WHEN 'AssignedPriority'											THEN CONVERT(SQL_VARIANT,[Priority] )  
   WHEN 'EstimatedRiskReduction'									THEN CONVERT(SQL_VARIANT,(r.LossEstimateBefore - r.LossEstimateAfter) )  
   WHEN 'LossEstimatePriorToImplementation'							THEN CONVERT(SQL_VARIANT,r.LossEstimateBefore )  
   WHEN 'LossEstimatePriorToImplementationCategory'					THEN CONVERT(SQL_VARIANT,r.LossEstimateBefore )  
   WHEN 'LossEstimateAfterImplementation'							THEN CONVERT(SQL_VARIANT,r.LossEstimateAfter )  
   WHEN 'EstimatedCostToComplete'									THEN CONVERT(SQL_VARIANT,[EstCostToComplete] )  
   WHEN 'EstimatedCostToCompleteCategory'							THEN CONVERT(SQL_VARIANT,[EstCostToComplete] )  
   WHEN 'CostBenefitRatio'											THEN CONVERT(SQL_VARIANT,((ISNULL(r.LossEstimateBefore,0) - ISNULL(r.LossEstimateAfter,0)) / ( CASE r.EstCostToComplete WHEN NULL THEN 1 WHEN 0 THEN 1 ELSE r.EstCostToComplete END)) )  
   WHEN 'LossScenario'												THEN CONVERT(SQL_VARIANT,[LocationID] ) -- TODO: can't convert NVARCHAR(max)  
   --WHEN 'ImplementationStatus'										THEN CONVERT(SQL_VARIANT,( CASE r.OverallRecommendationStatusID   
   --WHEN @NoPlansOrDisagreeOverallRecommendationStatus THEN @NoPlansOrDisagreeValidated   WHEN @VerifiedCompleteOverallRecommendationStatus 
   --THEN @VerifiedComplete  ELSE r.RecommendationStatusID END ) )  
   --WHEN 'ImplementationStatusChangeDate'							THEN CONVERT(SQL_VARIANT,'' ) -- TODO  
   --WHEN 'RecommendationResponseStatusChangeDate'					THEN CONVERT(SQL_VARIANT,'')  

    --WHEN 'ImplementationStatus'										THEN CONVERT(SQL_VARIANT,[RecommendationStatusID])  
	 WHEN 'ImplementationStatus'										
	THEN CONVERT(SQL_VARIANT,case when [RecommendationStatusID] = 1 then 1    
              when  [RecommendationStatusID] = 5 then 2   
              when [RecommendationStatusID] = 4 then 3 
              when [RecommendationStatusID] = 3 then 4
			  when [RecommendationStatusID] = 6 then 5
			  when [RecommendationStatusID] = 2 then 6
			    END) 
   WHEN 'ImplementationStatusChangeDate'							THEN CONVERT(SQL_VARIANT,[RecommendationStatusChangedDate]) -- TODO  
   WHEN 'RecommendationResponseStatusChangeDate'					THEN CONVERT(SQL_VARIANT,[RecommendationResponseStatusChangeDate]) 

   WHEN 'TargetDate'												THEN CONVERT(SQL_VARIANT,[TargetDate] )  
   WHEN 'Comments'													THEN CONVERT(SQL_VARIANT,[LocationID] ) -- TODO: can't convert NVARCHAR(max)  
   WHEN 'ActualCostToComplete'										THEN CONVERT(SQL_VARIANT,( SELECT TOP 1 ActCostToComplete FROM RecommendationPermanentData rpd WHERE rpd.LPRecKey = r.LPRecKey AND rpd.LPAllPiKey = r.LPAllPiKey ORDER BY [CreatedDate] DESC))  
   WHEN 'Priority'													THEN CONVERT(SQL_VARIANT,[Priority] )  
   WHEN 'RecommendationResponseDesigneeEmail'						THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'RecommendationAssignedDesigneeEmail'						THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'MyCommentOne'											    THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'MyCommentTwo'											    THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'MyCommentThree'										    THEN CONVERT(SQL_VARIANT,'' )  
   WHEN 'SharedComment'												THEN CONVERT(SQL_VARIANT,'' )  
   --WHEN 'CurrentImplementationStatus'							    THEN CONVERT(SQL_VARIANT,[RecommendationStatusID] )
    WHEN 'CurrentImplementationStatus'										
	THEN CONVERT(SQL_VARIANT,case when [RecommendationStatusID] = 1 then 1    
              when  [RecommendationStatusID] = 5 then 2   
              when [RecommendationStatusID] = 4 then 3 
              when [RecommendationStatusID] = 3 then 4
			  when [RecommendationStatusID] = 6 then 5
			  when [RecommendationStatusID] = 2 then 6
			    END) 
   WHEN 'CurrentRecommendationResponseStatus'					    THEN CONVERT(SQL_VARIANT,[RecommendationResponseStatusID] )  
   WHEN 'CurrentRecommendationStatus'							    THEN CONVERT(SQL_VARIANT,(r.OverallRecommendationStatusID ) )   
   WHEN 'CompletedDate'                 				            THEN CONVERT(SQL_VARIANT,[CompletedDate])
   WHEN 'DetailedRecommendation'                 				    THEN CONVERT(SQL_VARIANT,'')
   ELSE CONVERT(SQL_VARIANT, r.LocationID)  
   END ASC, r.LocationID ASC  
   ),   -- Column "Row Number"
   r.ID, -- Column "ID"
   0    -- Column "Is Return"  
   FROM Recommendation  r (NOLOCK)  
    
  INNER JOIN [Location] l (NOLOCK) ON l.ID = r.LocationID  
  INNER JOIN #TempLocations t (NOLOCK) ON t.ID = l.LPAllPiKey  
  INNER JOIN [RecommendationStatus] implementationStatus (NOLOCK) ON implementationStatus.ID = r.RecommendationStatusID   
  LEFT JOIN [RecommendationCategory] cat (NOLOCK) ON cat.ID = r.RecommendationCategoryID  
  LEFT JOIN [RecommendationType] [type] (NOLOCK) ON r.RecommendationTypeID = [type].ID  
  LEFT JOIN [Division] d (NOLOCK) ON d.ID = l.DivisionID  
  LEFT JOIN [SubDivision] sd (NOLOCK) ON sd.ID = l.SubDivisionID  
  WHERE   
  r.LPAcctKey = @LpAcctKey   
  AND  
  (  
   @LocationID IS NULL OR r.LocationID = @LocationID  
  )    
  AND  
  (  
  -- Apply SelectedRecommendationID List  
   @Filter_All  in (SELECT rid.ID FROM @SelectedRecommendationIDsList rid )  
   OR --EXISTS (SELECT rid.ID FROM @SelectedRecommendationIDsList rid WHERE r.LPRecKey = rid.ID and r.LPAcctKey = @LpAcctKey)  
   (  
   r.LPRecKey in (SELECT rid.ID FROM @SelectedRecommendationIDsList rid ) AND r.LPAcctKey = @LpAcctKey  
   )  
  )  
  AND  
  (  
   -- Apply Category Filter  
   @Filter_All IN  (SELECT ID FROM @FilterCategory)  
    OR  
   (  
    r.RecommendationCategoryID IN (SELECT ID FROM @FilterCategory)    
   )  
  )  
  
  AND   
  (  
   -- Apply Type Filter  
   @Filter_All IN  (SELECT ID FROM @FilterType) OR  
  
   (  
    r.RecommendationTypeID IN (SELECT ID FROM @FilterType)    
   )  
  )  
  AND   
  (  
   -- Apply Implementation Status Filter  
   @Filter_All IN  (SELECT ID FROM @FilterImplementationStatus) OR  
  
   (  
			CASE WHEN @Filter_Validated_Client = '23' and r.OverallRecommendationStatusID = 2 
			THEN 3 ELSE r.RecommendationStatusID END IN (SELECT ID FROM @FilterImplementationStatus)

  )) 
  AND   
  (  
   -- Apply Recommendation Status Filter  
   CASE WHEN @Filter_Validated_Client = '23' THEN 2 ELSE @Filter_All END IN  (SELECT ID FROM @FilterRecommendationStatus) OR  
  
   (  
      
	 r.OverallRecommendationStatusID IN (SELECT ID FROM @FilterRecommendationStatus)    
   )  
  )  
  AND   
  (  
   -- Apply Recommendation Status Filter  
   @Filter_All IN  (SELECT ID FROM @FilterRecommendationResponseStatus) OR  
  
   (  
      r.RecommendationResponseStatusID IN (SELECT ID FROM @FilterRecommendationResponseStatus)
    )
  )  
  
  AND   
  (  
   -- Apply LE Prior To Complete Category Filter  
   @Filter_All IN  (SELECT ID FROM @FilterLEPriorToImplementation) OR  
  
   (  
     ( @LE_Filter_Blank IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore IS NULL  ) OR  
     ( @LE_Filter_Low IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore <= @LECategoryUpperThreshold_Low  ) OR  
     ( @LE_Filter_Medium IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore > @LECategoryUpperThreshold_Low AND r.LossEstimateBefore <= @LECategoryUpperThreshold_Medium) OR  
     ( @LE_Filter_High IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore > @LECategoryUpperThreshold_Medium AND r.LossEstimateBefore <= @LECategoryUpperThreshold_High) OR  
     ( @LE_Filter_Critical IN (SELECT ID FROM @FilterLEPriorToImplementation) AND r.LossEstimateBefore > @LECategoryUpperThreshold_High)  
   )  
  )  
  AND   
  (  
   -- Apply Est Cost To Complete Category Filter  
   @Filter_All IN  (SELECT ID FROM @FilterEstCostToCompleteCategory) OR  
  
   (  
     ( @EstCost_Filter_Blank IN (SELECT ID FROM @FilterEstCostToCompleteCategory) AND r.EstCostToComplete IS NULL  ) OR  
     ( @EstCost_Filter_Low IN (SELECT ID FROM @FilterEstCostToCompleteCategory) AND r.EstCostToComplete <= @EstCostToCompleteUpperThreshold_Low  ) OR  
     ( @EstCost_Filter_Medium IN (SELECT ID FROM @FilterEstCostToCompleteCategory) AND r.EstCostToComplete > @EstCostToCompleteUpperThreshold_Low AND r.EstCostToComplete <= @EstCostToCompleteUpperThreshold_Medium) OR  
     ( @EstCost_Filter_High IN (SELECT ID FROM @FilterEstCostToCompleteCategory) AND r.EstCostToComplete > @EstCostToCompleteUpperThreshold_Medium)   
   )  
  )  
  AND   
  (  
   -- Apply Peril Filter  
   @Filter_All IN  (SELECT ID FROM @FilterPeril) OR  
   (  
     ( @Peril_Filter_Fire  IN (SELECT ID FROM @FilterPeril) and ([type].LossTypeId = @LossType_Filter_Fire))   
     OR  
     ( @Peril_Filter_MachineryBreakdown  IN (SELECT ID FROM @FilterPeril) and ([type].LossTypeID = @LossType_Filter_MachineryBreakdown)) OR  
     ( @Peril_Filter_NaturalCatastrophe  IN (SELECT ID FROM @FilterPeril) and ([type].LossTypeID = @LossType_Filter_NaturalCatastrophe))    
   )  
  )  
  AND    
  (  
   @Filter_All in (SELECT rid.ID FROM #TempReclist rid )  
   OR  
   (  
   r.LPRecKey in (SELECT rid.ID FROM #TempReclist rid )   
   )  
  )  
  END

 SELECT @TotalRows  = COUNT(*) FROM #MatchesId
  
  IF @SortDirection = 'ASC'  
  UPDATE #MatchesId SET IsReturn=1   
  WHERE  
   RowNumber > @StartRowIndex AND RowNumber <= (@StartRowIndex + (@PageSize))  
  ELSE  
  UPDATE #MatchesId SET IsReturn=1   
    WHERE  
     RowNumber >= (@TotalRows-@StartRowIndex-@PageSize+1) AND RowNumber <= (@TotalRows-@StartRowIndex)  
  
 INSERT INTO #Matches  
 SELECT   
   s.RowNumber,  
   s.ID,  
   s.LocationID,  
   s.LPRecKey,  
   s.LocationName,  
   s.LocationCode,  
   s.LocationNo,  
   s.ClientLocationNo,  
   s.LPAllPiKey,  
   s.DivisionName,  
   s.SubDivisionName,  
   s.AddressLine1,  
   s.AddressLine2,  
   s.City,  
   s.[State],  
   s.Country,  
   s.LocationValue,  
   s.PDValue,  
   s.BIValue,  
   s.TotalInsurableValue,  
   s.RecID,  
   s.OverallRecommendationStatusID,  
   s.RecommendationStatusChangeDate,  
   s.Summary,  
   s.LineOfBusiness,  
   s.Peril,  
   s.RecommendationCategoryID,  
   s.RecommendationTypeID,  
   s.RecommendationClientIntentID,  
   s.FacilityComment,  
   s.RecommendationProbabilityID,  
   s.IssuedDate,  
   s.RecommendationSourceID,  
   s.LastSurveyConsultant,  
   s.LastSurveyDate,  
   s.NextSurveyConsultant,  
   s.NextSurveyDate,  
   s.[Priority],  
   s.EstimatedRiskReduction,  
   s.LossEstimatePriorToImplementation,  
   s.LossEstimatePriorToImplementationCategory,  
   s.LossEstimateAfterImplementation,  
   s.EstCostToComplete,  
   s.EstimatedCostToCompleteCategory,  
   s.CostBenefitRatio,  
   s.LossScenario,  
   s.RecommendationStatusID,  
   s.RecommendationResponseStatusChangeDate,  
   s.ImplementationStatusChangeDate,  
   s.OverallRecommendationStatusChangeDate,
   s.TargetDate,  
   s.CustomerIntentDescription,
   s.ActualCostToComplete,  
   s.RecAssignedDesigneeEmail,  
   s.RecResponseDesigneeEmail,  
   s.MyCommentOne,  
   s.MyCommentTwo,  
   s.MyCommentThree,  
   s.SharedComment,  
   s.RecommendationStatusID,
   s.CurrentRecommendationResponseStatusID,
   s.CompletedDate,  
   s.DetailedRecommendation,
   s.OverallRecommendationStatusID,
   s.OverallRecommendationStatusYearMinusOne,
   s.OverallRecommendationStatusYearMinusTwo,
   s.OverallRecommendationStatusYearMinusThree,
   s.OverallRecommendationStatusYearMinusFour,
   s.OverallRecommendationStatusYearMinusFive,
   s.RecommendationStatusYearMinusOne,
   s.RecommendationStatusYearMinusTwo,
   s.RecommendationStatusYearMinusThree,
   s.RecommendationStatusYearMinusFour,
   s.RecommendationStatusYearMinusFive,
   s.RecommendationResponseStatusYearMinusOne,
   s.RecommendationResponseStatusYearMinusTwo,
   s.RecommendationResponseStatusYearMinusThree,
   s.RecommendationResponseStatusYearMinusFour,
   s.RecommendationResponseStatusYearMinusFive
  
    
 FROM   
 (  
 SELECT  
   m.RowNumber,  
   r.ID,  
   r.LPRecKey,  
   r.LocationID,  
   l.[Name] as [LocationName],  
   l.LocationCode,  
   l.LocationNo,  
   l.ClientLocationNo,  
   l.LPAllPiKey,  
   d.[Name] as DivisionName,  
   sd.[Name] as SubDivisionName,  
   l.[AddressLine1],  
   l.AddressLine2,  
   l.City,  
   l.[State],  
   l.Country,  
   l.LocationValue,  
   l.PDValue,  
   l.BIValue,  
   ISNULL(l.PDValue, 0) + ISNULL(l.BIValue, 0) as TotalInsurableValue,  
   RecID,    
   r.RecommendationStatusChangedDate AS RecommendationStatusChangeDate, 
   r.Summary,  
   '' AS LineOfBusiness, -- TODO, will default to "Property" for now  
   [type].LossTypeID AS Peril,  
   r.RecommendationCategoryID,  
   r.RecommendationTypeID,  
   r.RecommendationClientIntentID,  
   r.FacilityComment,  
   r.RecommendationProbabilityID,  
   r.IssuedDate,  
   r.RecommendationSourceID,  
   l.LastSurveyBy AS LastSurveyConsultant,  
   l.LastSurveyDate AS LastSurveyDate,  
   l.NextSurveyDate AS NextSurveyDate,  
   l.NextSurveyAssignedTo as NextSurveyConsultant,  
   r.[Priority],    
   ((r.LossEstimateBefore - r.LossEstimateAfter) - r.EstCostToComplete) AS EstimatedRiskReduction,  
   r.LossEstimateBefore AS LossEstimatePriorToImplementation,  
   '' AS LossEstimatePriorToImplementationCategory, -- this is mapped at run-time  
   r.LossEstimateAfter AS LossEstimateAfterImplementation,  
   r.EstCostToComplete,  
   '' AS EstimatedCostToCompleteCategory, -- this is mapped at run-time  
   CAST(
		CEILING(
				ROUND( (CAST(LossEstimateBefore AS DECIMAL) - CAST(LossEstimateAfter AS DECIMAL)) 
						/
						(CASE EstCostToComplete WHEN NULL THEN 1 WHEN 0 THEN 1 ELSE EstCostToComplete END) ,0)) AS BIGINT) 
		AS CostBenefitRatio,
   r.LossScenarioDescription AS LossScenario,    
   r.RecommendationStatusID  as RecommendationStatusID,
   r.OverallRecommendationStatusChangedDate AS OverallRecommendationStatusChangeDate,
   r.RecommendationStatusChangedDate as ImplementationStatusChangeDate,
   r.RecommendationResponseStatusID AS RecommendationResponseStatus,  
   r.RecommendationResponseStatusChangeDate AS RecommendationResponseStatusChangeDate, 
   r.TargetDate AS TargetDate,
   r.CustomerIntentDescription,
         
	( SELECT TOP 1  CASE WHEN 
		(SELECT COUNT(IsModified) AS IsModified FROM RecommendationPermanentData WHERE  LPRecKey =r.LPRecKey AND IsModified=1)  > 0 THEN
			(SELECT TOP 1 ActCostToComplete FROM RecommendationPermanentData rpd WHERE rpd.LPRecKey =r.LPRecKey AND rpd.LPAllPiKey = r.LPAllPiKey AND IsModified=1 ORDER BY [CreatedDate] DESC )
		ELSE 
			(SELECT TOP 1 ActCostToComplete FROM RecommendationPermanentData rpd WHERE rpd.LPRecKey =r.LPRecKey AND rpd.LPAllPiKey = r.LPAllPiKey AND  ActCostToComplete IS NOT NULL ORDER BY [CreatedDate] DESC)  
		END)
		AS ActualCostToComplete,

   '' AS RecResponseDesigneeEmail,   
   '' AS RecAssignedDesigneeEmail,
   '' AS MyCommentOne,	  -- TODO as part of User Story 146879
   '' AS MyCommentTwo,	  -- TODO as part of User Story 146879
   '' AS MyCommentThree, -- TODO as part of User Story 146879  
   '' AS SharedComment, -- TODO as part of User Story 146879 
   
     r.RecommendationResponseStatusID AS CurrentRecommendationResponseStatusID,  
	 r.CompletedDate as CompletedDate,
	 ISNULL(r.DescriptionSanitised,'') as DetailedRecommendation,
	 r.OverallRecommendationStatusChangedDate,
	 r.OverallRecommendationStatusID,
	 r.OverallRecommendationStatusYearMinusOne,
	 r.OverallRecommendationStatusYearMinusTwo,
	 r.OverallRecommendationStatusYearMinusThree,
	 r.OverallRecommendationStatusYearMinusFour,
	 r.OverallRecommendationStatusYearMinusFive,
	 r.RecommendationStatusYearMinusOne,
	 r.RecommendationStatusYearMinusTwo,
	 r.RecommendationStatusYearMinusThree,
	 r.RecommendationStatusYearMinusFour,
	 r.RecommendationStatusYearMinusFive,
	 r.RecommendationResponseStatusYearMinusOne,
	 r.RecommendationResponseStatusYearMinusTwo,
	 r.RecommendationResponseStatusYearMinusThree,
	 r.RecommendationResponseStatusYearMinusFour,
	 r.RecommendationResponseStatusYearMinusFive	
  FROM Recommendation  r (NOLOCK)  
    
  INNER JOIN [Location] l (NOLOCK) on l.ID = r.LocationID  
  INNER JOIN [RecommendationStatus] implementationStatus (NOLOCK) on implementationStatus.ID = r.RecommendationStatusID   
  LEFT JOIN [RecommendationCategory] cat (NOLOCK) on cat.ID = r.RecommendationCategoryID  
  LEFT JOIN [RecommendationType] [type] (NOLOCK) on r.RecommendationTypeID = [type].ID  
  LEFT JOIN [Division] d (NOLOCK) on d.ID = l.DivisionID  
  LEFT JOIN [SubDivision] sd (NOLOCK) on sd.ID = l.SubDivisionID  
  INNER JOIN #MatchesId m ON m.ID = r.ID  

  WHERE   
  m.IsReturn = 1 
  )s  
  
 GROUP BY   
   s.ID,  
   s.RowNumber,  
   s.LocationID,  
   s.LPRecKey,  
   s.LocationName,  
   s.LocationCode,  
   s.LocationNo,  
   s.ClientLocationNo,  
   s.LPAllPiKey,  
   s.DivisionName,  
   s.SubDivisionName,  
   s.AddressLine1,  
   s.AddressLine2,  
   s.City,  
   s.[State],  
   s.Country,  
   s.LocationValue,  
   s.PDValue,  
   s.BIValue,  
   s.TotalInsurableValue,  
   s.RecID,  
   s.OverallRecommendationStatusID,  
   s.RecommendationStatusChangeDate,  
   s.ImplementationStatusChangeDate,  
   s.OverallRecommendationStatusChangeDate,
   s.Summary,  
   s.LineOfBusiness,  
   s.Peril,  
   s.RecommendationCategoryID,  
   s.RecommendationTypeID,  
   s.RecommendationClientIntentID,  
   s.FacilityComment,  
   s.RecommendationProbabilityID,  
   s.IssuedDate,  
   s.RecommendationSourceID,  
   s.LastSurveyConsultant,  
   s.LastSurveyDate,  
   s.NextSurveyConsultant,  
   s.NextSurveyDate,  
   s.[Priority],  
   s.EstimatedRiskReduction,  
   s.LossEstimatePriorToImplementation,  
   s.LossEstimatePriorToImplementationCategory,  
   s.LossEstimateAfterImplementation,  
   s.EstCostToComplete,  
   s.EstimatedCostToCompleteCategory,  
   s.CostBenefitRatio,  
   s.LossScenario,  
   s.RecommendationStatusID,  
   s.RecommendationResponseStatusChangeDate,  
   s.TargetDate,  
   s.CustomerIntentDescription,
   s.ActualCostToComplete,  
   s.RecAssignedDesigneeEmail,  
   s.RecResponseDesigneeEmail,  
   s.MyCommentOne,  
   s.MyCommentTwo,  
   s.MyCommentThree,  
   s.SharedComment,  
   s.CurrentRecommendationResponseStatusID,
   s.CompletedDate,
   s.DetailedRecommendation,
   s.OverallRecommendationStatusYearMinusOne,
   s.OverallRecommendationStatusYearMinusTwo,
   s.OverallRecommendationStatusYearMinusThree,
   s.OverallRecommendationStatusYearMinusFour,
   s.OverallRecommendationStatusYearMinusFive,
   s.RecommendationResponseStatusYearMinusOne,
   s.RecommendationResponseStatusYearMinusTwo,
   s.RecommendationResponseStatusYearMinusThree,
   s.RecommendationResponseStatusYearMinusFour,
   s.RecommendationResponseStatusYearMinusFive,
   s.RecommendationResponseStatusYearMinusOne,
   s.RecommendationStatusYearMinusOne,
   s.RecommendationStatusYearMinusTwo,
   s.RecommendationStatusYearMinusThree,
   s.RecommendationStatusYearMinusFour,
   s.RecommendationStatusYearMinusFive
  
  
  
 IF @SortDirection = 'ASC'  
 BEGIN  
   
  SELECT   
  
  m.*
  FROM #Matches m  
  ORDER BY RowNumber ASC  
    
  END  
  ELSE  
  BEGIN  
  
  SELECT   
  m.*  
  FROM #Matches m  
     
  ORDER BY RowNumber DESC  
  END  
  END  
   
  RETURN 0
GO


